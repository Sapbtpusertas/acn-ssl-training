<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive SSL Training for SAP Basis Consultants</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A two-column, "documentation-style" SPA. The left column provides a fixed, hierarchical navigation menu (like a book's table of contents), allowing users to quickly access any topic. The right column is the dynamic content panel, displaying only the selected topic. This structure is optimal for dense, technical training material, as it breaks down complexity into focused, manageable sections. It prevents user overload from a long, single-scrolling page and facilitates both linear learning and quick, non-linear reference for professionals who need to look up specific information. Interactive elements like the handshake simulator and command explorer are embedded directly within their relevant content sections to enhance contextual learning. -->
    <!-- Visualization & Content Choices:
        - Report Info: SSL/TLS Handshake Process -> Goal: Explain a complex sequence -> Viz/Presentation: Interactive, step-by-step diagram using HTML/CSS -> Interaction: "Next Step" buttons reveal each stage of the handshake, animating the flow and updating explanatory text. Justification: More engaging and easier to follow than a static list. Library/Method: Vanilla JS, Tailwind CSS.
        - Report Info: `sapgenpse` commands -> Goal: Make command-line syntax easy to reference -> Viz/Presentation: An interactive accordion/tabbed component for all `sapgenpse` commands. -> Interaction: Clicking a command name expands to show details, syntax, options in a table, and a code example with a copy button. Justification: Organizes dense reference material into a compact, user-friendly interface. Library/Method: Vanilla JS, Tailwind CSS.
        - Report Info: Certificate Formats (PEM, PFX, etc.) -> Goal: Compare and contrast formats -> Viz/Presentation: A responsive grid of visually distinct cards. -> Interaction: Each card clearly presents one format's definition and use cases. Justification: A visually appealing and scannable way to present categorical information. Library/Method: Vanilla JS, Tailwind CSS.
        - Report Info: Live SSL Handshake Practical -> Goal: Provide a hands-on learning tool -> Viz/Presentation: An input field, button, and results panel. -> Interaction: User enters a URL; a JS function simulates the handshake and displays a detailed, realistic analysis (TLS version, cipher, cert chain). Justification: Provides a safe, interactive way to demonstrate a live network process without requiring a backend. The simulation gives the educational value of the interaction. Library/Method: Vanilla JS.
        - NEW: `sapgenpse` Command Generator (LLM-powered) -> Goal: Generate specific `sapgenpse` commands based on natural language input. -> Viz/Presentation: Input text area and a button, displaying generated command in a code block. -> Interaction: User describes command, clicks button, LLM generates command. If LLM is unsure, it returns relevant `sapgenpse -h` section. Justification: Directly assists users in constructing complex `sapgenpse` commands, making the tool more accessible and practical, with a fallback to official documentation. Library/Method: Gemini API (gemini-2.0-flash), Vanilla JS, Tailwind CSS.
        - NEW: SSL Troubleshooting Assistant (LLM-powered) -> Goal: Provide solutions for SSL/TLS errors. -> Viz/Presentation: Input text area and a button, displaying suggested causes and solutions. -> Interaction: User describes error, clicks button, LLM provides diagnosis. Justification: Offers immediate, context-aware troubleshooting advice, enhancing the practical utility of the training. Library/Method: Gemini API (gemini-2.0-flash), Vanilla JS, Tailwind CSS.
    -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
        }
        .nav-link.active {
            background-color: #e0f2f1; /* A subtle teal */
            color: #00796b; /* Darker teal */
            font-weight: 600;
            border-left: 3px solid #00796b;
        }
        .nav-link:hover {
            background-color: #f1f5f9;
        }
        .handshake-step {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .handshake-step.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .handshake-arrow {
            transition: opacity 0.5s ease;
        }
        .code-block {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #e2e8f0;
            color: #475569;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #cbd5e1;
        }
        .sapgenpse-accordion-content {
            display: none;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        h1, h2, h3, h4 {
            color: #1e293b;
        }
        /* Styles for the handshake diagram from the new file */
        .handshake-diagram-svg {
            width: 100%;
            max-width: 600px;
            height: auto;
            margin: 20px auto; /* Center the SVG */
            display: block;
        }
        .handshake-diagram-svg .arrow {
            stroke: #333;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }
        .handshake-diagram-svg rect {
            border-radius: 8px; /* Apply rounded corners to SVG rects */
        }
        .handshake-diagram-svg text {
            font-size: 12px;
            font-weight: bold;
        }
        .handshake-step-detail {
            padding: 15px;
            background-color: #f1f5f9;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: opacity 0.5s ease-in-out;
            display: none; /* Hidden by default */
        }
        .handshake-step-detail.active {
            display: block;
            opacity: 1;
        }
        .handshake-step-detail ul {
            list-style: disc;
            padding-left: 20px;
            margin-top: 10px;
        }
        .handshake-step-detail ul li {
            margin-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        table th, table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        table th {
            background-color: #f8fafc;
            font-weight: 600;
        }
        table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        table tbody tr:nth-child(even) {
            background-color: #f1f5f9;
        }

        /* Styles for encryption diagrams */
        .encryption-diagram {
            width: 100%;
            max-width: 300px;
            height: 150px;
            margin: 10px auto;
            display: block;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #fff;
        }
        .flow-diagram-container {
            position: relative;
            width: 100%;
            height: 600px; /* Increased height for ICM flow */
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #fff;
            overflow: hidden; /* Ensure elements don't spill outside */
        }
        .flow-node {
            position: absolute;
            background-color: #bfdbfe;
            border: 1px solid #60a5fa;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e40af;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .flow-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border: none;
            background-color: transparent;
            z-index: 1;
        }
        .flow-arrow::before {
            content: '';
            position: absolute;
            background-color: #333;
        }
        .flow-arrow.horizontal::before {
            height: 2px;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
        }
        .flow-arrow.vertical::before {
            width: 2px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }
        .flow-arrow.right::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 8px solid #333;
        }
        .flow-arrow.left::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-right: 8px solid #333;
        }
        .flow-arrow.down::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 8px solid #333;
        }
        .flow-arrow.up::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 8px solid #333;
        }
        .flow-label {
            position: absolute;
            font-size: 0.75rem;
            color: #475569;
            white-space: nowrap;
        }

        /* Cover Page Specific Styles */
        .cover-page {
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: calc(100vh - 64px); /* Adjust for header/footer if any */
            padding: 2rem;
        }
        .cover-page-title {
            font-size: 3rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 1rem;
            line-height: 1.1;
        }
        .cover-page-subtitle {
            font-size: 1.5rem;
            font-weight: 500;
            color: #475569;
            margin-bottom: 2rem;
        }
        .cover-page-trainer {
            font-size: 1.25rem;
            font-weight: 600;
            color: #334155;
            margin-top: 2rem;
        }
        .cover-page-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 2rem;
            color: #00796b; /* Teal color for the icon */
        }

        /* Styles for the new combined ICM flow diagram */
        .combined-flow-diagram-container {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }
        .single-flow-diagram {
            position: relative;
            width: 100%;
            max-width: 450px; /* Max width for each diagram */
            height: 750px; /* Increased height for more space */
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            background-color: #fff;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* More prominent shadow */
            padding: 15px; /* Added padding */
        }
        .single-flow-diagram .flow-node {
            background-color: #e0f7fa; /* Light blue-green */
            border-color: #00bcd4; /* Cyan */
            color: #006064; /* Dark cyan */
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .single-flow-diagram .flow-arrow::before {
            background-color: #00796b; /* Darker teal for arrows */
        }
        .single-flow-diagram .flow-arrow.right::after,
        .single-flow-diagram .flow-arrow.left::after,
        .single-flow-diagram .flow-arrow.down::after,
        .single-flow-diagram .flow-arrow.up::after {
            border-color: transparent transparent transparent #00796b; /* Match arrow color */
        }
        .single-flow-diagram .flow-label {
            color: #263238; /* Darker text for labels */
            font-weight: 500;
        }
        .diagram-title {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
        }

        /* Specific node colors for clarity in the new diagram */
        .node-client { background-color: #bfdbfe; border-color: #60a5fa; color: #1e40af; }
        .node-web-dispatcher { background-color: #d1fae5; border-color: #065f46; color: #065f46; }
        .node-ascs { background-color: #fef9c3; border-color: #92400e; color: #92400e; }
        .node-message-server { background-color: #e0f2f1; border-color: #00796b; color: #00796b; }
        .node-app-server { background-color: #bfdbfe; border-color: #60a5fa; color: #1e40af; }
        .node-external-server { background-color: #ffe0b2; border-color: #e65100; color: #e65100; }
        .node-sap-client { background-color: #c8e6c9; border-color: #388e3c; color: #1b5e20; } /* Greenish for SAP as client */
    </style>
</head>
<body class="bg-stone-50 text-slate-700">

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Left Navigation Panel -->
        <aside class="w-full md:w-80 bg-white/80 backdrop-blur-sm border-r border-stone-200 p-4 md:fixed md:h-full md:overflow-y-auto">
            <h1 class="text-xl font-bold text-slate-800 mb-4">SSL Training for SAP</h1>
            <nav id="navigation-menu">
                <ul>
                    <li><a href="#cover-page" class="nav-link block p-2 rounded-md font-medium text-slate-600">Cover Page</a></li>
                    <li>
                        <a href="#intro" class="nav-link block p-2 rounded-md font-medium text-slate-600">I. SSL/TLS Fundamentals</a>
                        <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#intro-what-is" class="nav-link block p-2 text-sm">What are SSL/TLS?</a></li>
                           <li><a href="#intro-crypto" class="nav-link block p-2 text-sm">Key Cryptographic Concepts</a></li>
                           <li><a href="#intro-pki" class="nav-link block p-2 text-sm">Public Key Infrastructure</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#handshake" class="nav-link block p-2 rounded-md font-medium text-slate-600">II. The SSL/TLS Handshake</a>
                         <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#handshake-tls12" class="nav-link block p-2 text-sm">TLS 1.2 Process</a></li>
                           <li><a href="#handshake-tls13" class="nav-link block p-2 text-sm">TLS 1.3 Enhancements</a></li>
                           <li><a href="#handshake-interactive" class="nav-link block p-2 text-sm">Interactive Handshake</a></li>
                           <li><a href="#handshake-live" class="nav-link block p-2 text-sm">Practical: Live Handshake</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#formats" class="nav-link block p-2 rounded-md font-medium text-slate-600">III. Certificate Formats</a>
                         <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#formats-common" class="nav-link block p-2 text-sm">Common Formats</a></li>
                           <li><a href="#formats-stores" class="nav-link block p-2 text-sm">Key Stores & Bundles</a></li>
                           <li><a href="#formats-conversions" class="nav-link block p-2 text-sm">Conversions</a></li>
                           <li><a href="#formats-sap" class="nav-link block p-2 text-sm">Use Cases in SAP</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#sap-specifics" class="nav-link block p-2 rounded-md font-medium text-slate-600">IV. SAP-Specific Management</a>
                         <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#sap-pse" class="nav-link block p-2 text-sm">SAP PSE & CryptoLib</a></li>
                           <li><a href href="#sap-sapgenpse" class="nav-link block p-2 text-sm">The `sapgenpse` Tool</a></li>
                           <li><a href="#sap-genpse-llm" class="nav-link block p-2 text-sm">✨ Command Generator</a></li>
                           <li><a href="#sap-renewal" class="nav-link block p-2 text-sm">Certificate Renewal</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#config" class="nav-link block p-2 rounded-md font-medium text-slate-600">V. SSL/TLS Configuration in SAP</a>
                        <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#config-abap" class="nav-link block p-2 text-sm">ABAP Stack (STRUST)</a></li>
                           <li><a href="#config-java" class="nav-link block p-2 text-sm">Java Stack (NWA)</a></li>
                           <li><a href="#config-web" class="nav-link block p-2 text-sm">Web Dispatcher</a></li>
                           <li><a href="#icm-flow-diagram" class="nav-link block p-2 text-sm">ICM Communication Flow</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#rfc-gateway" class="nav-link block p-2 rounded-md font-medium text-slate-600">VI. SAP RFC Gateway: Architecture and Security</a>
                        <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#rfc-overview" class="nav-link block p-2 text-sm">Gateway Overview</a></li>
                           <li><a href="#rfc-tp-rfcexec" class="nav-link block p-2 text-sm">TP & `rfcexec`</a></li>
                           <li><a href="#rfc-security-files" class="nav-link block p-2 text-sm">Security Files (`reginfo`, `secinfo`, `prxyinfo`, `ms_acl`)</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#snc-sso" class="nav-link block p-2 rounded-md font-medium text-slate-600">VII. Secure Network Communications (SNC) & SSO</a>
                         <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#snc-overview" class="nav-link block p-2 text-sm">SNC Overview</a></li>
                           <li><a href="#snc-config" class="nav-link block p-2 text-sm">SNC Configuration</a></li>
                           <li><a href="#snc-ad-sso" class="nav-link block p-2 text-sm">SNC with AD for SSO</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#web-services" class="nav-link block p-2 rounded-md font-medium text-slate-600">VIII. SAP Web Services and ICM Services</a>
                        <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#sicf" class="nav-link block p-2 text-sm">SICF</a></li>
                           <li><a href="#soamanager-sproxy" class="nav-link block p-2 text-sm">SOAMANAGER & SPROXY</a></li>
                           <li><a href="#httpurlloc" class="nav-link block p-2 text-sm">HTTPURLLOC Table</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#advanced-topics" class="nav-link block p-2 rounded-md font-medium text-slate-600">IX. Advanced Topics</a>
                        <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#advanced-hsm" class="nav-link block p-2 text-sm">HSM Integration</a></li>
                           <li><a href="#advanced-performance" class="nav-link block p-2 text-sm">Performance Optimization</a></li>
                           <li><a href="#advanced-best-practices" class="nav-link block p-2 text-sm">Security Best Practices</a></li>
                        </ul>
                    </li>
                    <li class="mt-2">
                        <a href="#troubleshooting-final" class="nav-link block p-2 rounded-md font-medium text-slate-600">X. Troubleshooting & Diagnostics</a>
                        <ul class="ml-4 mt-1 border-l border-stone-200">
                           <li><a href="#troubleshooting-common" class="nav-link block p-2 text-sm">Common Issues</a></li>
                           <li><a href="#troubleshooting-llm" class="nav-link block p-2 text-sm">✨ Troubleshooting Assistant</a></li>
                        </ul>
                    </li>
                     <li class="mt-2">
                        <a href="#conclusion" class="nav-link block p-2 rounded-md font-medium text-slate-600">XI. Conclusion</a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Right Content Panel -->
        <main class="w-full md:ml-80 p-6 md:p-10">
            <div id="content-container">
                <!-- Cover Page -->
                <section id="cover-page" class="content-section cover-page">
                    <svg class="cover-page-logo" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-2 4h4m6-10V2a2 2 0 00-2-2H4a2 2 0 00-2 2v10a2 2 0 002 2h4l-1 3h8l-1-3h4a2 2 0 002-2z" />
                    </svg>
                    <h1 class="cover-page-title">Comprehensive SSL Certificate Training</h1>
                    <h2 class="cover-page-subtitle">For SAP Basis Consultants</h2>
                    <p class="cover-page-trainer">Trainer: Your Name Here</p>
                    <p class="cover-page-trainer">Date: July 2025</p>
                </section>

                <!-- Section I -->
                <section id="intro" class="content-section prose max-w-none prose-slate">
                    <h2>I. Introduction to SSL/TLS Fundamentals</h2>
                    <p class="lead text-lg">Secure communication protocols are indispensable in modern digital environments, forming the bedrock of trust and data protection across networks. This foundational module establishes a robust understanding of these protocols, tracing their historical evolution and delving into the cryptographic principles that underpin their functionality.</p>
                    
                    <h3 id="intro-what-is">What are SSL/TLS Certificates?</h3>
                    <p>SSL/TLS certificates are digital documents that enable secure, encrypted communication over computer networks. Their core purpose is to provide privacy, data integrity, and authenticity. The evolution from the now-deprecated Secure Sockets Layer (SSL) to the modern Transport Layer Security (TLS) marks a critical progression in internet security. While "SSL" is often used colloquially, all modern secure connections use TLS, with versions 1.2 and 1.3 being the current standards.</p>
                    <p>TLS 1.3 represents a substantial advancement, streamlining the connection process (the "handshake") to reduce latency and removing support for older, vulnerable cryptographic algorithms. For SAP Basis consultants, this continuous evolution means security configurations are not static; they demand constant monitoring and planned upgrade cycles.</p>
                    <p>In SAP systems, SSL/TLS secures HTTP-based applications (e.g., SAP Fiori, Web Dynpro), REST/SOAP APIs, and internal communications (e.g., RFCs, Secure Network Communication [SNC]), protecting sensitive data such as financial transactions, user credentials, and business processes. Compliance with regulations like GDPR, PCI-DSS, and HIPAA mandates robust TLS implementations in SAP environments.</p>

                    <h3 id="intro-crypto">Key Cryptographic Concepts</h3>
                    <p>Secure communication relies on a hybrid approach combining different cryptographic techniques:</p>
                    <div class="grid md:grid-cols-2 gap-6 mt-4">
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <h4 class="font-semibold text-slate-800">Symmetric Encryption</h4>
                            <p class="mt-2 text-sm">Uses a single, shared secret key for both encryption and decryption. It's incredibly fast, ideal for encrypting bulk data. The main challenge is securely sharing the key. Common algorithms include AES-256-GCM, ChaCha20-Poly1305.</p>
                            <svg class="encryption-diagram" viewBox="0 0 300 150">
                                <rect x="20" y="50" width="80" height="50" fill="#bfdbfe" rx="8" ry="8"/>
                                <text x="60" y="80" text-anchor="middle" fill="#1e40af" font-size="14">Data</text>

                                <circle cx="150" cy="75" r="20" fill="#d1fae5"/>
                                <text x="150" y="78" text-anchor="middle" fill="#065f46" font-size="12">Key</text>

                                <rect x="200" y="50" width="80" height="50" fill="#bfdbfe" rx="8" ry="8"/>
                                <text x="240" y="80" text-anchor="middle" fill="#1e40af" font-size="14">Data</text>

                                <line x1="100" y1="75" x2="130" y2="75" stroke="#333" stroke-width="2" marker-end="url(#arrowhead-small)"/>
                                <line x1="170" y1="75" x2="200" y2="75" stroke="#333" stroke-width="2" marker-end="url(#arrowhead-small)"/>
                                <defs>
                                    <marker id="arrowhead-small" markerWidth="8" markerHeight="5" refX="0" refY="2.5" orient="auto">
                                        <polygon points="0 0, 8 2.5, 0 5" fill="#333" />
                                    </marker>
                                </defs>
                            </svg>
                        </div>
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                           <h4 class="font-semibold text-slate-800">Asymmetric Encryption</h4>
                           <p class="mt-2 text-sm">Uses a pair of keys: a public key to encrypt and a private key to decrypt. It's much slower but solves the key exchange problem. TLS uses asymmetric encryption to securely establish a temporary symmetric key for the session. Prominent algorithms include RSA, ECC (Elliptic Curve Cryptography).</p>
                           <svg class="encryption-diagram" viewBox="0 0 300 150">
                                <rect x="20" y="50" width="60" height="50" fill="#bfdbfe" rx="8" ry="8"/>
                                <text x="50" y="80" text-anchor="middle" fill="#1e40af" font-size="14">Data</text>

                                <circle cx="120" cy="40" r="15" fill="#d1fae5"/>
                                <text x="120" y="43" text-anchor="middle" fill="#065f46" font-size="10">Pub Key</text>

                                <circle cx="180" cy="110" r="15" fill="#d1fae5"/>
                                <text x="180" y="113" text-anchor="middle" fill="#065f46" font-size="10">Priv Key</text>

                                <rect x="220" y="50" width="60" height="50" fill="#bfdbfe" rx="8" ry="8"/>
                                <text x="250" y="80" text-anchor="middle" fill="#1e40af" font-size="14">Data</text>

                                <line x1="80" y1="75" x2="110" y2="50" stroke="#333" stroke-width="2" marker-end="url(#arrowhead-small)"/>
                                <line x1="190" y1="90" x2="220" y2="75" stroke="#333" stroke-width="2" marker-end="url(#arrowhead-small)"/>
                            </svg>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 mt-4">
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                           <h4 class="font-semibold text-slate-800">Hashing</h4>
                           <p class="mt-2 text-sm">Hashing creates a unique, fixed-size fingerprint (a "hash" or "digest") of data. Any change to the data results in a completely different hash, ensuring data integrity. Algorithms like SHA-256 or SHA-384 are used.</p>
                           <svg class="encryption-diagram" viewBox="0 0 300 150">
                                <rect x="20" y="50" width="80" height="50" fill="#bfdbfe" rx="8" ry="8"/>
                                <text x="60" y="80" text-anchor="middle" fill="#1e40af" font-size="14">Input Data</text>

                                <rect x="130" y="60" width="40" height="30" fill="#d1fae5" rx="4" ry="4"/>
                                <text x="150" y="80" text-anchor="middle" fill="#065f46" font-size="12">H</text>

                                <rect x="200" y="50" width="80" height="50" fill="#bfdbfe" rx="8" ry="8"/>
                                <text x="240" y="80" text-anchor="middle" fill="#1e40af" font-size="14">Hash Output</text>

                                <line x1="100" y1="75" x2="130" y2="75" stroke="#333" stroke-width="2" marker-end="url(#arrowhead-small)"/>
                                <line x1="170" y1="75" x2="200" y2="75" stroke="#333" stroke-width="2" marker-end="url(#arrowhead-small)"/>
                            </svg>
                        </div>
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                           <h4 class="font-semibold text-slate-800">Digital Signatures</h4>
                           <p class="mt-2 text-sm">Digital Signatures provide authenticity. A sender hashes a message and then encrypts the hash with their private key. The recipient decrypts the hash with the sender's public key and compares it to their own hash of the message. A match proves the sender's identity and that the message wasn't altered.</p>
                           <svg class="encryption-diagram" viewBox="0 0 300 150">
                                <rect x="20" y="20" width="60" height="30" fill="#bfdbfe" rx="4" ry="4"/>
                                <text x="50" y="38" text-anchor="middle" fill="#1e40af" font-size="12">Data</text>

                                <rect x="20" y="90" width="60" height="30" fill="#bfdbfe" rx="4" ry="4"/>
                                <text x="50" y="108" text-anchor="middle" fill="#1e40af" font-size="12">Data</text>

                                <rect x="90" y="20" width="40" height="30" fill="#d1fae5" rx="4" ry="4"/>
                                <text x="110" y="38" text-anchor="middle" fill="#065f46" font-size="12">H</text>

                                <rect x="90" y="90" width="40" height="30" fill="#d1fae5" rx="4" ry="4"/>
                                <text x="110" y="108" text-anchor="middle" fill="#065f46" font-size="12">H</text>

                                <circle cx="180" cy="35" r="15" fill="#fef9c3"/>
                                <text x="180" y="38" text-anchor="middle" fill="#92400e" font-size="10">Priv Key</text>

                                <circle cx="180" cy="105" r="15" fill="#fef9c3"/>
                                <text x="180" y="108" text-anchor="middle" fill="#92400e" font-size="10">Pub Key</text>

                                <rect x="220" y="20" width="60" height="30" fill="#bfdbfe" rx="4" ry="4"/>
                                <text x="250" y="38" text-anchor="middle" fill="#1e40af" font-size="12">Signature</text>

                                <rect x="220" y="90" width="60" height="30" fill="#bfdbfe" rx="4" ry="4"/>
                                <text x="250" y="108" text-anchor="middle" fill="#1e40af" font-size="12">Verified</text>

                                <line x1="80" y1="35" x2="90" y2="35" stroke="#333" stroke-width="1" marker-end="url(#arrowhead-small)"/>
                                <line x1="130" y1="35" x2="165" y2="35" stroke="#333" stroke-width="1" marker-end="url(#arrowhead-small)"/>
                                <line x1="195" y1="35" x2="220" y2="35" stroke="#333" stroke-width="1" marker-end="url(#arrowhead-small)"/>

                                <line x1="80" y1="105" x2="90" y2="105" stroke="#333" stroke-width="1" marker-end="url(#arrowhead-small)"/>
                                <line x1="130" y1="105" x2="165" y1="105" stroke="#333" stroke-width="1" marker-end="url(#arrowhead-small)"/>
                                <line x1="195" y1="105" x2="220" y2="105" stroke="#333" stroke-width="1" marker-end="url(#arrowhead-small)"/>
                            </svg>
                        </div>
                    </div>
                    <p class="mt-4"><strong>Key Exchange</strong>: Methods like RSA, Diffie-Hellman (DH), or Elliptic Curve Diffie-Hellman (ECDH) securely establish session keys, with ECDH preferred for forward secrecy.</p>

                    <h3 id="intro-pki" class="mt-8">Public Key Infrastructure (PKI): The Chain of Trust</h3>
                    <p>PKI is the framework of hardware, software, and policies that manages digital certificates. It's built on a hierarchy of trust, ensuring that a public key truly belongs to the entity that claims it.</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>Certificate Authority (CA):</strong> A trusted third party that issues digital certificates.</li>
                        <li><strong>Root CA:</strong> The ultimate source of trust. Its certificate is self-signed and pre-installed in browsers and operating systems.</li>
                        <li><strong>Intermediate CA:</strong> Acts as a bridge between the highly protected Root CA and the end-entity certificates issued to servers.</li>
                        <li><strong>End-Entity Certificate:</strong> The certificate issued to a specific server (e.g., your SAP Web Dispatcher).</li>
                    </ul>
                    <p class="mt-4">A client trusts your server's certificate only if it can follow an unbroken "chain of trust" from your certificate, through any intermediate certificates, all the way up to a Root CA that it already trusts.</p>
                    <p class="mt-4"><strong>Practical Exercise:</strong> Using Chrome DevTools (Security tab), inspect the certificate of an SAP system’s HTTPS endpoint (e.g., <a href="https://<server>:8443/sap/public/ping" target="_blank" class="text-blue-600 hover:underline">https://&lt;server&gt;:8443/sap/public/ping</a>) to identify the issuer, validity period, key algorithm, and cipher suite. Document the certificate chain and verify the root CA.</p>
                </section>

                <!-- Section II -->
                <section id="handshake" class="content-section prose max-w-none prose-slate">
                    <h2>II. The SSL/TLS Handshake in Detail</h2>
                    <p class="lead text-lg">The TLS handshake establishes a secure session between a client (e.g., browser, SAP GUI) and a server (e.g., SAP NetWeaver), negotiating cryptographic parameters, authenticating identities, and generating session keys. This section details the TLS 1.2 handshake (RFC 5246), widely used in SAP systems, with a focus on client-server dialogues and response codes.</p>

                    <h3 id="handshake-tls12">TLS 1.2 Handshake Process</h3>
                    <div class="bg-white p-6 rounded-lg border border-stone-200 mt-4 not-prose">
                        <div class="relative flex items-center justify-between p-4 min-h-[600px]"> <!-- Increased min-height -->
                            <!-- Client -->
                            <div class="text-center w-1/3">
                                <div class="mx-auto bg-blue-100 text-blue-800 w-20 h-20 rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                                </div>
                                <p class="mt-2 font-semibold">Client</p>
                            </div>

                            <!-- Messages -->
                            <div class="absolute inset-0 flex flex-col items-center justify-center space-y-4">
                                <div id="handshake-message-1" class="handshake-message absolute top-[50px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">Client Hello</p>
                                    <div class="handshake-arrow text-3xl text-slate-400">&rightarrow;</div>
                                </div>
                                <div id="handshake-message-2" class="handshake-message absolute top-[90px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <div class="handshake-arrow text-3xl text-slate-400">&leftarrow;</div>
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">Server Hello</p>
                                </div>
                                <div id="handshake-message-3" class="handshake-message absolute top-[130px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <div class="handshake-arrow text-3xl text-slate-400">&leftarrow;</div>
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">Certificate</p>
                                </div>
                                <div id="handshake-message-4" class="handshake-message absolute top-[170px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <div class="handshake-arrow text-3xl text-slate-400">&leftarrow;</div>
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">ServerKeyExchange*</p>
                                </div>
                                <div id="handshake-message-5" class="handshake-message absolute top-[210px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <div class="handshake-arrow text-3xl text-slate-400">&leftarrow;</div>
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">CertificateRequest*</p>
                                </div>
                                <div id="handshake-message-6" class="handshake-message absolute top-[250px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <div class="handshake-arrow text-3xl text-slate-400">&leftarrow;</div>
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">ServerHelloDone</p>
                                </div>
                                <div id="handshake-message-7" class="handshake-message absolute top-[290px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">Client Certificate*</p>
                                    <div class="handshake-arrow text-3xl text-slate-400">&rightarrow;</div>
                                </div>
                                <div id="handshake-message-8" class="handshake-message absolute top-[330px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">ClientKeyExchange</p>
                                    <div class="handshake-arrow text-3xl text-slate-400">&rightarrow;</div>
                                </div>
                                <div id="handshake-message-9" class="handshake-message absolute top-[370px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">CertificateVerify*</p>
                                    <div class="handshake-arrow text-3xl text-slate-400">&rightarrow;</div>
                                </div>
                                <div id="handshake-message-10" class="handshake-message absolute top-[410px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">ChangeCipherSpec (Client)</p>
                                    <div class="handshake-arrow text-3xl text-slate-400">&rightarrow;</div>
                                </div>
                                <div id="handshake-message-11" class="handshake-message absolute top-[450px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <div class="handshake-arrow text-3xl text-slate-400">&leftarrow;</div>
                                    <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">ChangeCipherSpec (Server)</p>
                                </div>
                                <div id="handshake-message-12" class="handshake-message absolute top-[490px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <p class="font-mono text-sm bg-green-100 text-green-800 px-2 py-1 rounded">Finished (Client)</p>
                                    <div class="handshake-arrow text-3xl text-slate-400">&rightarrow;</div>
                                </div>
                                <div id="handshake-message-13" class="handshake-message absolute top-[530px] left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-500">
                                    <div class="handshake-arrow text-3xl text-slate-400">&leftarrow;</div>
                                    <p class="font-mono text-sm bg-green-100 text-green-800 px-2 py-1 rounded">Finished (Server)</p>
                                </div>
                            </div>

                            <!-- Server -->
                            <div class="text-center w-1/3">
                                 <div class="mx-auto bg-teal-100 text-teal-800 w-20 h-20 rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" /></svg>
                                </div>
                                <p class="mt-2 font-semibold">Server</p>
                            </div>
                        </div>
                        <div class="mt-4 text-center min-h-[150px]"> <!-- Added min-height to prevent button movement -->
                            <p id="handshake-explanation" class="text-slate-600 min-h-[4em]">Click "Next Step" to begin the handshake visualization.</p>
                            <button id="handshake-btn" class="mt-4 bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition">Next Step</button>
                            <button id="handshake-reset-btn" class="mt-4 ml-2 bg-gray-400 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-500 transition">Reset</button>
                        </div>
                    </div>

                    <h3 id="handshake-tls13" class="mt-8">TLS 1.3 Handshake Enhancements</h3>
                    <p>TLS 1.3 significantly improves on this process by being faster and more secure:</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>Streamlined Handshake:</strong> It dramatically reduces the number of round trips required to establish a secure connection, leading to faster connection establishment and reduced latency.</li>
                        <li><strong>0-RTT (Zero Round Trip Time):</strong> For resumed sessions, TLS 1.3 can achieve 0-RTT, enabling data to be sent immediately with the first client message.</li>
                        <li><strong>Removed Weak/Obsolete Algorithms:</strong> A key security improvement in TLS 1.3 is the removal of support for many older, less secure features and algorithms that were still present in TLS 1.2.</li>
                        <li><strong>Enhanced Privacy:</strong> TLS 1.3 encrypts more parts of the initial handshake communication, making it more challenging for attackers to eavesdrop on session establishments.</li>
                        <li><strong>Mandatory Perfect Forward Secrecy (PFS):</strong> All cipher suites supported in TLS 1.3 inherently include Perfect Forward Secrecy.</li>
                    </ul>
                    
                    <h3 id="handshake-live" class="mt-8">Practical: SSL Certificate Viewer & Connection Simulator</h3>
                    <p>This tool simulates a connection to a web server to analyze its SSL/TLS configuration or report connection errors. Enter a URL (e.g., `https://www.google.com`, `http://example.com`, `https://expired.badssl.com`) and click "Get Details" to see what a real analysis would reveal. This provides a practical look at how different servers are configured and how errors manifest.</p>
                    <div class="bg-white p-6 rounded-lg border border-stone-200 mt-4 not-prose">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input id="live-url-input" type="text" value="https://www.google.com" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Enter URL e.g., https://www.google.com">
                            <button id="live-test-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">Get Details</button>
                        </div>
                        <div id="live-results-container" class="mt-4">
                            <!-- Results will be injected here -->
                        </div>
                        <p class="mt-4 text-sm text-slate-500">
                            <strong>Note:</strong> Due to browser security restrictions (CORS), this tool provides a robust *simulation* of certificate details and connection errors for various scenarios (e.g., valid, expired, untrusted, hostname mismatch, HTTP). It cannot fetch live SSL certificate details from arbitrary external or internal company URLs directly via client-side JavaScript. For real-world analysis of internal company domains or SAP ICMs, a server-side proxy or a dedicated network analysis tool (like OpenSSL `s_client` or Wireshark) would be required.
                        </p>
                    </div>
                    <p class="mt-4"><strong>Practical Exercise:</strong> Use Wireshark to capture a TLS handshake from an SAP system’s HTTPS endpoint, identifying ClientHello, ServerHello, Certificate, and Finished messages. Simulate a handshake failure by configuring mismatched cipher suites in ICM and analyze the TLS alert code.</p>
                </section>
                
                <!-- Section III -->
                <section id="formats" class="content-section prose max-w-none prose-slate">
                    <h2>III. Understanding Certificate Formats and Use Cases</h2>
                     <p class="lead text-lg">Certificates and keys come in a variety of file formats, which can be a common source of confusion. Understanding the difference between formats like PEM, DER, and PFX is crucial for correct implementation in different SAP components and for interoperability between systems.</p>

                    <h3 id="formats-common">Common Certificate & Key Formats</h3>
                    <table class="table w-full text-left border-collapse mt-4">
                        <thead>
                            <tr>
                                <th class="border-b-2 p-2 bg-slate-50 font-semibold">Format</th>
                                <th class="border-b-2 p-2 bg-slate-50 font-semibold">Extension(s)</th>
                                <th class="border-b-2 p-2 bg-slate-50 font-semibold">Description</th>
                                <th class="border-b-2 p-2 bg-slate-50 font-semibold">Contains</th>
                                <th class="border-b-2 p-2 bg-slate-50 font-semibold">Standard</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2">PEM</td>
                                <td class="p-2">.pem, .crt, .cer, .key</td>
                                <td class="p-2">Base64-encoded ASCII, human-readable, delimited by `-----BEGIN/END-----` headers</td>
                                <td class="p-2">Certificates, private keys, CA certificates</td>
                                <td class="p-2">RFC 1421-1424</td>
                            </tr>
                            <tr>
                                <td class="p-2">PFX/P12</td>
                                <td class="p-2">.pfx, .p12, .pkcs12</td>
                                <td class="p-2">Encrypted binary container, password-protected</td>
                                <td class="p-2">Server certificate, private key, CA certificates</td>
                                <td class="p-2">PKCS#12, RFC 7292</td>
                            </tr>
                            <tr>
                                <td class="p-2">DER</td>
                                <td class="p-2">.der, .cer</td>
                                <td class="p-2">Binary-encoded, not human-readable</td>
                                <td class="p-2">Certificates or private keys</td>
                                <td class="p-2">ASN.1 DER</td>
                            </tr>
                            <tr>
                                <td class="p-2">KEY</td>
                                <td class="p-2">.key</td>
                                <td class="p-2">PEM-encoded private key</td>
                                <td class="p-2">Private key only</td>
                                <td class="p-2">De facto standard</td>
                            </tr>
                            <tr>
                                <td class="p-2">P7B</td>
                                <td class="p-2">.p7b, .p7c</td>
                                <td class="p-2">Base64-encoded, contains certificate chains</td>
                                <td class="p-2">Certificates, intermediate CAs</td>
                                <td class="p-2">PKCS#7, RFC 2315</td>
                            </tr>
                            <tr>
                                <td class="p-2">CSR</td>
                                <td class="p-2">.csr, .req</td>
                                <td class="p-2">Certificate Signing Request, Base64-encoded</td>
                                <td class="p-2">Public key, subject details</td>
                                <td class="p-2">PKCS#10, RFC 2986</td>
                            </tr>
                            <tr>
                                <td class="p-2">P10</td>
                                <td class="p-2">.p10</td>
                                <td class="p-2">Alternative CSR format</td>
                                <td class="p-2">Public key, subject details</td>
                                <td class="p-2">PKCS#10</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 id="formats-stores" class="mt-8">Key Stores and Certificate Bundles</h3>
                     <div class="grid md:grid-cols-2 gap-6 mt-4 not-prose">
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <h4 class="font-semibold text-slate-800">PKCS#12 (.pfx, .p12)</h4>
                            <p class="mt-2 text-sm">A password-protected container file that bundles a private key with its corresponding certificate and the full CA chain. It's a binary format ideal for exporting/importing/migrating a complete identity between systems, especially into SAP Java (NWA) and the SAP Web Dispatcher.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <h4 class="font-semibold text-slate-800">JKS (.jks)</h4>
                            <p class="mt-2 text-sm">Java KeyStore. The native, proprietary keystore format for Java applications. It is password-protected and can hold private keys and trusted CA certificates.</p>
                        </div>
                    </div>
                    
                    <h3 id="formats-conversions" class="mt-8">Certificate Format Conversions (using OpenSSL)</h3>
                    <p>OpenSSL is a powerful command-line tool for cryptographic operations, including certificate format conversions. These conversions are critical for ensuring compatibility across different platforms and SAP components.</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>PFX to PEM</strong>: Extracts certificate and private key from a PFX file into PEM format. The `-nodes` option ensures the private key is not encrypted.
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">openssl pkcs12 -in certificate.pfx -out certificate.pem -nodes</code></pre>
                            </div>
                        </li>
                        <li><strong>PEM to PFX</strong>: Combines a PEM-encoded certificate, private key, and optional CA bundle into a single PFX file.
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">openssl pkcs12 -export -out certificate.pfx -inkey private.key -in certificate.crt -certfile ca-bundle.crt</code></pre>
                            </div>
                        </li>
                        <li><strong>DER to PEM</strong>: Converts a binary DER-encoded certificate to text-based PEM format.
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">openssl x509 -inform der -in certificate.der -out certificate.pem</code></pre>
                            </div>
                        </li>
                    </ul>
                    <p class="mt-4"><strong>Practical Exercise:</strong> Convert a PFX file to PEM using OpenSSL, import it into a `SAPSSLS.pse` using `sapgenpse`, and verify the certificate details with `sapgenpse get_my_name -p SAPSSLS.pse -v`.</p>

                    <h3 id="formats-sap" class="mt-8">When to use which format in SAP</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse mt-4">
                            <thead>
                                <tr>
                                    <th class="border-b-2 p-2 bg-slate-50 font-semibold">Format</th>
                                    <th class="border-b-2 p-2 bg-slate-50 font-semibold">Primary SAP Use Case</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="p-2 font-mono">.pem, .crt</td>
                                    <td class="p-2">Importing trusted CA certificates and server certificate responses into SAP ABAP via <strong>STRUST</strong>.</td>
                                </tr>
                                 <tr class="border-b bg-white">
                                    <td class="p-2 font-mono">.csr</td>
                                    <td class="p-2">Generating a certificate request from <strong>STRUST</strong> or <strong>`sapgenpse`</strong> to be sent to a CA.</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-2 font-mono">.pfx, .p12</td>
                                    <td class="p-2">Importing a complete identity (private key + cert chain) into <strong>SAP Java (NWA)</strong> and the <strong>SAP Web Dispatcher</strong>. Also for exporting a full PSE from SAP.</td>
                                </tr>
                                <tr class="border-b bg-white">
                                    <td class="p-2 font-mono">.pse</td>
                                    <td class="p-2">SAP's proprietary Personal Security Environment format. The native keystore for ABAP systems, managed with <strong>STRUST</strong> and <strong>`sapgenpse`</strong>.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </section>
                
                <!-- Section IV -->
                <section id="sap-specifics" class="content-section prose max-w-none prose-slate">
                    <h2>IV. SAP-Specific SSL Certificate Management</h2>
                    <p class="lead text-lg">SAP has its own unique ecosystem for managing cryptographic information. This module covers the core components: the Personal Security Environment (PSE), the essential SAP Cryptographic Library, and the powerful `sapgenpse` command-line tool, which is a must-know for every Basis consultant.</p>

                    <h3 id="sap-pse">SAP Personal Security Environment (PSE) & SAP Cryptographic Library</h3>
                    <p>SAP systems use proprietary files called <strong>Personal Security Environments (PSEs)</strong> to store key pairs and certificates. These are functionally similar to a JKS keystore. Key PSEs you will encounter are:</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><code>SAPSSLS.pse</code>: For the SSL <strong>Server</strong> certificate, used for incoming HTTPS connections.</li>
                        <li><code>SAPSSLC.pse</code>: For SSL <strong>Client</strong> certificates, used for outgoing HTTPS calls from SAP.</li>
                        <li><code>SAPSNCS.pse</code>: For Secure Network Communications (SNC) between SAP components.</li>
                        <li><code>System PSE</code>: For system-wide security, used in SNC.</li>
                        <li><code>Application PSE</code>: For specific SAP applications like Fiori.</li>
                    </ul>
                    <p class="mt-4">The functionality of these PSEs is powered by the <strong>SAP Cryptographic Library (CommonCryptoLib)</strong>, successor to SAPCRYPTOLIB. This library provides all the encryption and digital signature functions. It supports algorithms like RSA, ECDSA, AES, and SHA-256/384, is FIPS 140-2 certified, and integrates with hardware security modules (HSMs). It is a mandatory prerequisite for using `sapgenpse` and enabling SSL/TLS. You must ensure it is installed, up-to-date (by checking SAP Notes like <a href="https://launchpad.support.sap.com/#/notes/2809914" target="_blank" class="text-blue-600 hover:underline">SAP Note 2809914</a>), and that the <code>SECUDIR</code> environment variable correctly points to its location (typically `/usr/sap/<SID>/SYS/exe/run/`).</p>

                    <h3 id="sap-sapgenpse" class="mt-8">The `sapgenpse` Command-Line Tool: An Interactive Explorer</h3>
                    <p>The `sapgenpse` tool is a powerful command-line utility for creating and managing PSEs, certificates, and credentials. It's essential for automation and for situations where GUI access (STRUST) is unavailable. Run `sapgenpse -h` for comprehensive help. Click on a command below to see its purpose, syntax, and a practical example.</p>
                    <div id="sapgenpse-accordion" class="space-y-2 mt-4 not-prose">
                        <!-- Accordion items will be injected here by JS -->
                    </div>
                    
                    <h3 id="sap-genpse-llm" class="mt-8">✨ `sapgenpse` Command Generator</h3>
                    <p>Describe what you want to achieve with `sapgenpse` in plain English, and the Gemini API will generate the appropriate command for you. If it's unsure, it will provide a relevant section from the `sapgenpse -h` help output.</p>
                    <div class="bg-white p-6 rounded-lg border border-stone-200 mt-4 not-prose">
                        <textarea id="sapgenpse-prompt" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-transparent min-h-[80px]" placeholder="e.g., Generate a CSR for my web dispatcher with SANs for webdisp.example.com and wd.example.com"></textarea>
                        <button id="generate-sapgenpse-btn" class="mt-2 bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition">Generate Command ✨</button>
                        <div id="sapgenpse-output" class="mt-4 code-block hidden">
                            <button class="copy-btn">Copy</button>
                            <pre><code class="language-bash"></code></pre>
                        </div>
                        <div id="sapgenpse-loading" class="text-center p-4 hidden">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-900 mx-auto"></div>
                            <p class="mt-2">Generating command...</p>
                        </div>
                    </div>

                    <h3 id="sap-renewal" class="mt-8">Certificate Renewal Process</h3>
                    <p>Proactive certificate renewal is critical to avoid service outages. An expired certificate will immediately cause connection failures.</p>
                     <p><strong>Best Practices:</strong></p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>Monitor Expiration:</strong> Use monitoring tools to alert you at least 30-60 days before a certificate expires.</li>
                        <li><strong>Generate a New Key Pair (Recommended):</strong> For maximum security, the best practice is to generate a completely new key pair and CSR for the renewal. This limits the exposure time of any single private key.</li>
                        <li><strong>Re-use Existing Key (Re-signing):</strong> For convenience, you can generate a new CSR from the existing private key (using `sapgenpse gen_pse -onlyreq -j`). This is simpler but less secure than creating a new key. The `-j` option ensures that any existing Subject Alternative Names (SANs) from the PSE are preserved and carried over to the new certificate request. The `-onlyreq` option instructs the tool to generate only the CSR from the existing PSE, while ignoring other parameters like the distinguished name or algorithm, as these settings are derived from the existing PSE.</li>
                        <li><strong>Update the Full Chain:</strong> When you import the new certificate, ensure you also import the latest intermediate CA chain from your provider, as these can change.</li>
                        <li><strong>Check Revocation Status:</strong> Understand that certificates can be revoked before they expire (e.g., if a key is compromised). Clients check this status using Certificate Revocation Lists (CRLs) or the Online Certificate Status Protocol (OCSP).</li>
                    </ul>
                    <p class="mt-4"><strong>Practical Exercise:</strong> Simulate a certificate renewal in a test system by generating a new CSR while retaining existing SANs, importing the new certificate, and restarting ICM/J2EE engine/Web Dispatcher. Test the new certificate using `openssl s_client -connect <host>:8443` and `sapgenpse get_my_name -p SAPSSLS.pse -v`.</p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-bash">sapgenpse gen_pse -p SAPSSLS.pse -j -onlyreq -r new_request.csr -x mypin
# Submit CSR to CA (manual step)
sapgenpse import_own_cert -p SAPSSLS.pse -c new_cert.crt -r ca-bundle.crt -x mypin
# Verify the imported certificate
sapgenpse get_my_name -p SAPSSLS.pse -v -x mypin
# For ABAP: Restart ICM via SMICM -> Admin -> ICM -> Restart -> Yes
# For Java: Restart J2EE engine via sapcontrol -nr <instance_number> -function Restart
# For Web Dispatcher: Restart Web Dispatcher via sapcontrol -nr <instance_number> -function Restart</code></pre>
                    </div>
                </section>

                <!-- Section V: SSL/TLS Configuration in SAP Systems (Moved from VII) -->
                <section id="config" class="content-section prose max-w-none prose-slate">
                     <h2>V. SSL/TLS Configuration in SAP Systems</h2>
                     <p class="lead text-lg">Configuring SSL/TLS is a core task for a Basis consultant. The process differs significantly between the ABAP stack, the Java stack, and the SAP Web Dispatcher. This section provides a practical overview of the tools and key steps for each environment.</p>

                    <h3 id="config-abap">SAP ABAP Stack (STRUST)</h3>
                    <p>The <strong>Trust Manager (transaction <code>STRUST</code>)</strong> is the primary GUI for managing PSEs and certificates in the ABAP stack.</p>
                    <h4 class="font-semibold text-slate-800 mt-4">Prerequisites:</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>SAP NetWeaver 7.0 or higher.</li>
                        <li>CommonCryptoLib installed in `/usr/sap/<SID>/SYS/exe/run/`.</li>
                        <li>Administrator access to SAP GUI and STRUST.</li>
                        <li>HTTPS ports (e.g., 443, 8443) open in the firewall.</li>
                    </ul>
                    <h4 class="font-semibold text-slate-800 mt-4">Configuration Steps:</h4>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li>Run transaction <code>STRUST</code> in SAP GUI and select <strong>SSL Server Standard</strong> or create a new PSE.</li>
                        <li>Switch to change mode (pencil icon) and generate a CSR via <strong>Create Certificate Request</strong>, specifying details like CN, OU, and SANs (e.g., `sapserver.example.com`).</li>
                        <li>Submit the CSR to a CA (e.g., DigiCert, Sectigo) and obtain the signed certificate and CA chain.</li>
                        <li>Import the certificate response using <strong>Import Cert. Response</strong> and add intermediate/root CA certificates to the certificate list.</li>
                        <li>Save the PSE to `/usr/sap/<SID>/<Instance>/sec/`.</li>
                        <li>Distribute the PSE to all application servers if using server-specific PSEs (via STRUST or manual file copy).</li>
                        <li>Configure ICM parameters in transaction `RZ10` (or directly in instance profile):
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">icm/server_port_0 = PROT=HTTPS, PORT=8443, SSLCONFIG=ssl_config_0
icm/ssl_config_0 = VCLIENT=0, CRED=/usr/sap/<SID>/<Instance>/sec/SAPSSLS.pse
icm/HTTPS/verify_client = 1  # Enable mutual TLS if required
ssl/ciphersuites = 135:PFS:HIGH::EC_P256:EC_HIGH # Recommended for strong security
ssl/client_ciphersuites = 150:PFS:HIGH::EC_P256:EC_HIGH # For outbound connections
# Refer to SAP Note 510007 for latest ciphersuite recommendations
                                </code></pre>
                            </div>
                        </li>
                        <li>Restart ICM using `SMICM → Admin → ICM → Restart → Yes`.</li>
                        <li>Verify HTTPS access via <a href="https://<server>:8443/sap/public/ping" target="_blank" class="text-blue-600 hover:underline">https://&lt;server&gt;:8443/sap/public/ping</a>.</li>
                    </ol>
                    <p class="mt-4"><strong>Practical Exercise:</strong> Generate a CSR in STRUST, import a signed certificate, and configure ICM to enable HTTPS. Test the endpoint using `curl -v https://<server>:8443/sap/public/ping` and analyze the response to confirm TLS version and cipher suite.</p>

                     <h3 id="config-java" class="mt-8">SAP Java Stack (NWA Key Storage)</h3>
                    <p>In SAP Java systems, certificate management is done via the <strong>NetWeaver Administrator (NWA)</strong>, specifically in the "Key Storage" service.</p>
                    <h4 class="font-semibold text-slate-800 mt-4">Prerequisites:</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>SAP NetWeaver 7.1 or higher.</li>
                        <li>CommonCryptoLib installed.</li>
                        <li>Administrator access to NWA.</li>
                        <li>Java keystore tools (e.g., `keytool`) available.</li>
                    </ul>
                    <h4 class="font-semibold text-slate-800 mt-4">Configuration Steps:</h4>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li><strong>Generate CSR via `sapgenpse` (OS Level):</strong>
                            <p>While NWA can generate CSRs, it's often more flexible to generate the key pair and CSR at the OS level using `sapgenpse` for consistency, especially in unified certificate management scenarios. This creates a PSE (e.g., `SAPSSLS_JAVA.pse`).</p>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">sapgenpse get_pse -p SAPSSLS_JAVA.pse -x mypin -r java_request.csr "CN=myjava.host.com, OU=IT, O=MyCompany, C=US" -a RSA -s 2048</code></pre>
                            </div>
                        </li>
                        <li><strong>Submit CSR to CA and obtain signed certificate and CA chain.</strong></li>
                        <li><strong>Import Signed Certificate via `sapgenpse` (OS Level):</strong>
                            <p>Import the signed certificate and its full CA chain into the PSE created in step 1.</p>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">sapgenpse import_own_cert -p SAPSSLS_JAVA.pse -c signed_java_cert.crt -r ca-bundle.crt -x mypin</code></pre>
                            </div>
                        </li>
                        <li><strong>Verify Imported Certificate (OS Level):</strong>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">sapgenpse get_my_name -p SAPSSLS_JAVA.pse -v -x mypin</code></pre>
                            </div>
                        </li>
                        <li><strong>Convert PSE to P12 format:</strong>
                            <p>The Java Key Storage in NWA prefers PKCS#12 (`.p12`) format for importing key pairs. Convert the PSE to P12 using `sapgenpse`.</p>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">sapgenpse export_p12 -p SAPSSLS_JAVA.pse -x mypin -z p12password SAPSSLS_JAVA.p12 -C 0</code></pre>
                            </div>
                        </li>
                        <li><strong>Import P12 into NWA Key Storage:</strong>
                            <p>Access NWA via `https://<host>:<port>/nwa`. Navigate to <strong>Configuration → Certificates and Keys → Key Storage</strong>. Select or create a key storage view (e.g., `ICM_SSL_<instance_id>`). Use the "Import Entry" option and select the `SAPSSLS_JAVA.p12` file, providing its password.</p>
                        </li>
                        <li>Update profile parameters in `/usr/sap/<SID>/SYS/profile`:
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">icm/server_port_0 = PROT=HTTPS, PORT=5<instance_number>01, SSLCONFIG=ssl_config_0
icm/ssl_config_0 = VCLIENT=0, CRED=/usr/sap/<SID>/<Instance>/sec/SAPSSLS.pse
icm/HTTP/redirect_0 = PREFIX=/, FROM=*, FROMPROT=http, PROT=https, HOST=sap_host.domain, PORT=5<instance_number>01
ssl/ciphersuites = 135:PFS:HIGH::EC_P256:EC_HIGH
                                </code></pre>
                            </div>
                        </li>
                        <li>Restart the J2EE engine:
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">sapcontrol -nr <instance_number> -function Restart</code></pre>
                            </div>
                        </li>
                    </ol>
                    <p class="mt-4"><strong>Practical Exercise:</strong> Configure HTTPS in NWA, import a P12 file into the Java keystore, and verify HTTP-to-HTTPS redirection using a browser. Test cipher suite compatibility: `openssl s_client -connect <host>:5<instance_number>01 -tls1_2`.</p>

                    <h3 id="config-web" class="mt-8">SAP Web Dispatcher</h3>
                    <p>The SAP Web Dispatcher acts as a reverse proxy and is a critical point for SSL/TLS configuration. It can either pass through encrypted traffic or terminate it.</p>
                    <h4 class="font-semibold text-slate-800 mt-4">Prerequisites:</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>Web Dispatcher installed and configured.</li>
                        <li>`SECUDIR` environment variable set to `/usr/sap/<SID>/<Instance>/sec/`.</li>
                        <li>CommonCryptoLib installed.</li>
                        <li>SSL certificate files (`.crt`, `.p12`) available.</li>
                    </ul>
                     <p><strong>SSL Handling Modes:</strong></p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                         <li><strong>SSL Termination:</strong> The Web Dispatcher decrypts the incoming HTTPS request from the client. This is necessary for it to perform intelligent routing, load balancing, or content inspection. It requires its own SSL certificate.</li>
                         <li><strong>Re-encryption:</strong> After terminating the connection, the Web Dispatcher re-encrypts the traffic before sending it to the backend SAP system. This is the most secure and common configuration, ensuring end-to-end encryption.</li>
                         <li><strong>End-to-End SSL (Passthrough):</strong> The Web Dispatcher forwards the encrypted traffic directly to the backend without decrypting it. This is simpler but limits the Web Dispatcher's functionality.</li>
                    </ul>
                    <h4 class="font-semibold text-slate-800 mt-4">Configuration via Trust Manager (STRUST):</h4>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li>Run `STRUST` in the connected ABAP system.</li>
                        <li>Select the Web Dispatcher’s PSE (e.g., `SAPSSLS.pse`).</li>
                        <li>Import the certificate response and CA chain using <strong>Import Cert. Response</strong>.</li>
                        <li>Save the PSE to SECUDIR and restart the Web Dispatcher.</li>
                    </ol>
                    <h4 class="font-semibold text-slate-800 mt-4">Configuration via `sapgenpse`:</h4>
                    <p>Import a certificate into the PSE using `sapgenpse`:</p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-bash">sapgenpse import_own_cert -p SAPSSLS.pse -c ssl_certificate.crt -r ca-bundle.crt -x mypin</code></pre>
                    </div>
                    <p class="mt-4">Update the Web Dispatcher profile (`/usr/sap/<SID>/SYS/profile/SAPWEB_<instance>`):</p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-bash">wdisp/ssl_encrypt = 1 # 1 for re-encryption, 0 for passthrough
ssl/ssl_lib = /usr/sap/<SID>/SYS/exe/run/libsapcrypto.so
ssl/server_pse = /usr/sap/<SID>/<Instance>/sec/SAPSSLS.pse
icm/server_port_0 = PROT=HTTPS, PORT=443
ssl/ciphersuites = 135:PFS:HIGH::EC_P256:EC_HIGH
# wdisp/ssl_ignore_host_mismatch = 1 # Use with extreme caution
# wdisp/HTTP/use_pool_for_new_conn = 1 # For performance optimization
                        </code></pre>
                    </div>
                    <p class="mt-4"><strong>Practical Exercise:</strong> Configure SSL termination in Web Dispatcher using `sapgenpse`, then verify access via <a href="https://<webdispatcher>:443" target="_blank" class="text-blue-600 hover:underline">https://&lt;webdispatcher&gt;:443</a>. Test mutual TLS by configuring a client PSE and enabling `icm/HTTPS/verify_client=1`.</p>

                    <h3 id="icm-flow-diagram" class="mt-8">ICM Communication Flow & Unified Certificate Management</h3>
                    <p>Understanding the flow of HTTPS communication through an SAP landscape, especially with Web Dispatchers, is crucial for effective SSL/TLS management. This diagram illustrates a common scenario and how certificates are applied.</p>
                    <div class="combined-flow-diagram-container not-prose">
                        <!-- Diagram 1: Client to SAP System (SAP as Server) -->
                        <div class="single-flow-diagram">
                            <div class="diagram-title">Scenario 1: Client to SAP System (SAP as Server)</div>
                            <!-- Client -->
                            <div class="flow-node node-client" style="left: 50%; top: 40px; transform: translateX(-50%); width: 80px;">Client</div>
                            <div class="flow-arrow vertical down" style="left: 50%; top: 80px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 90px;">HTTPS</div>

                            <!-- Independent Web Dispatcher -->
                            <div class="flow-node node-web-dispatcher" style="left: 50%; top: 120px; transform: translateX(-50%); width: 180px;">
                                Independent Web Dispatcher
                                <br><span class="text-xs font-normal">(`SAPSSLS.pse`)</span>
                            </div>
                            <div class="flow-arrow vertical down" style="left: 50%; top: 200px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 210px;">HTTPS (Re-encrypted)</div>

                            <!-- Internal Web Dispatcher (ASCS/SCS) -->
                            <div class="flow-node node-ascs" style="left: 50%; top: 240px; transform: translateX(-50%); width: 220px;">
                                Internal Web Dispatcher (ASCS/SCS)
                                <br><span class="text-xs font-normal">(`SAPSSLS.pse` in ABAP, `SAPSSLS_JAVA.pse` in Java)</span>
                            </div>
                            <div class="flow-arrow vertical down" style="left: 50%; top: 320px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 330px;">HTTP/HTTPS</div>

                            <!-- Message Server -->
                            <div class="flow-node node-message-server" style="left: 50%; top: 360px; transform: translateX(-50%); width: 120px;">
                                Message Server
                            </div>
                            <div class="flow-arrow vertical down" style="left: 50%; top: 400px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 410px;">Internal Routing</div>

                            <!-- Application Server (ICM) -->
                            <div class="flow-node node-app-server" style="left: 50%; top: 440px; transform: translateX(-50%); width: 180px;">
                                Application Server (ICM)
                                <br><span class="text-xs font-normal">(`SAPSSLS.pse` for ABAP, `SAPSSLS_JAVA.pse` for Java PAS)</span>
                            </div>
                            <!-- Reverse Flow -->
                            <div class="flow-arrow vertical up" style="left: 50%; top: 430px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 420px;">Response</div>
                            <div class="flow-arrow vertical up" style="left: 50%; top: 350px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 340px;">Response</div>
                            <div class="flow-arrow vertical up" style="left: 50%; top: 230px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 220px;">Response</div>
                            <div class="flow-arrow vertical up" style="left: 50%; top: 110px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 100px;">Response</div>
                        </div>

                        <!-- Diagram 2: SAP System to External System (Outbound via Proxy) -->
                        <div class="single-flow-diagram">
                            <div class="diagram-title">Scenario 2: SAP System to External System (Outbound via Proxy)</div>
                            <!-- SAP Application Server (ICM) -->
                            <div class="flow-node node-app-server" style="left: 50%; top: 40px; transform: translateX(-50%); width: 220px;">
                                SAP Application Server (ICM)
                                <br><span class="text-xs font-normal">(`SAPSSLC.pse` for ABAP, Java Key Storage for Java)</span>
                                <br><span class="text-xs font-normal text-red-700">Needs Root & SubCA of External Server</span>
                            </div>
                            <div class="flow-arrow vertical down" style="left: 50%; top: 120px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 130px;">HTTPS Request</div>

                            <!-- Firewall/Proxy (Optional) -->
                            <div class="flow-node" style="left: 50%; top: 160px; transform: translateX(-50%); width: 150px; background-color: #e0f2f1; border-color: #00796b; color: #00796b;">
                                Firewall/Proxy
                            </div>
                            <div class="flow-arrow vertical down" style="left: 50%; top: 200px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 210px;">HTTPS</div>

                            <!-- External Server (e.g., Google.com) -->
                            <div class="flow-node node-external-server" style="left: 50%; top: 240px; transform: translateX(-50%); width: 180px;">
                                External Server (e.g., Google.com)
                            </div>
                            <!-- Reverse Flow (Responses) -->
                            <div class="flow-arrow vertical up" style="left: 50%; top: 230px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 220px;">HTTPS Response</div>
                            <div class="flow-arrow vertical up" style="left: 50%; top: 150px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 140px;">Response</div>
                            <div class="flow-arrow vertical up" style="left: 50%; top: 70px; height: 40px;"></div>
                            <div class="flow-label" style="left: calc(50% + 10px); top: 60px;">Response</div>
                        </div>
                    </div>
                    <p class="mt-4 text-sm text-slate-700">
                        <strong>Importance of `SAPSSLC.pse` and Trusted CAs:</strong>
                        The `SAPSSLC.pse` (for ABAP) and the corresponding Key Storage views in NWA (for Java) are crucial for SAP systems when they act as clients, initiating outbound HTTPS connections to external servers (e.g., cloud services, external APIs, BTP services, other SaaS applications). For these outbound connections to succeed, the SAP system must trust the certificate presented by the external server. This trust is established by ensuring that the Root CA and any Intermediate CAs that signed the external server's certificate are present and trusted within the `SAPSSLC.pse` or the relevant Java Key Storage trust list.
                        <br><br>
                        Ideally, all `SAPSSLC.pse` files and Java Key Storage trust lists throughout a customer's SAP landscape should contain:
                        <ul class="list-disc pl-5 mt-2 space-y-1">
                            <li>The customer's own internal Root and Subordinate CAs (for trusting other internal systems).</li>
                            <li>All major publicly trusted External CAs (for trusting external SaaS providers, SAP services like BTP, and other internet-facing applications).</li>
                        </ul>
                        Maintaining a comprehensive and up-to-date set of trusted CAs in `SAPSSLC.pse` and NWA Key Storage is vital for seamless and secure integration with the broader digital ecosystem.
                    </p>
                    <h4 id="unified-cert-mgmt" class="font-semibold text-slate-800 mt-8">Unified Certificate Management for an SAP SID</h4>
                    <p>For a given SAP System ID (SID), a unified approach to certificate management can simplify renewals and ensure consistency across all components that handle HTTPS traffic. This involves:</p>
                    <ol class="list-decimal pl-5 mt-4 space-y-2">
                        <li><strong>Single CSR Generation (OS Level `sapgenpse`):</strong>
                            <p>Generate a single Certificate Signing Request (CSR) at the OS level using `sapgenpse`. This CSR should include all relevant hostnames (physical FQDNs, virtual hostnames, CNAMES, and potentially IP addresses if required by policy) as Subject Alternative Names (SANs). This ensures that one certificate can cover all entry points for the SAP SID.</p>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash"># Example: Generate CSR for SID 'PRD' covering multiple hostnames
# Run this on the ASCS instance host where sapgenpse is available
cd /usr/sap/PRD/ASCS00/sec/ # Or your designated SECUDIR for ASCS
sapgenpse gen_pse -p SAPSSLS.pse -r prd_cert_request.csr \
-k GN-dNSName:prd.example.com \
-k GN-dNSName:fiori.example.com \
-k GN-dNSName:webdisp.example.com \
-k GN-iPAddress:192.168.1.100 \
"CN=prd.example.com, OU=SAP, O=MyCompany, C=US" -x mypin</code></pre>
                            </div>
                            <p class="mt-2 text-sm"><strong>Note:</strong> The `-j` option for `gen_pse` is typically used when renewing a certificate from an *existing* PSE to carry over its existing SANs. The `-onlyreq` option instructs the tool to generate only the CSR from the existing PSE, while ignoring other parameters like the distinguished name or algorithm, as these settings are derived from the existing PSE. For a truly unified approach where you are consolidating multiple hostnames onto a single new certificate, you explicitly list all SANs as shown above, even if starting with a new PSE or using an existing one and explicitly overriding its SANs.</p>
                        </li>
                        <li><strong>Certificate Signing by CA:</strong>
                            <p>Submit the generated `prd_cert_request.csr` to your Certificate Authority (CA) to get it signed. The CA will return the signed server certificate and potentially a CA bundle (intermediate and root certificates).</p>
                        </li>
                        <li><strong>Importing Certificate into ASCS/SCS PSE (OS Level `sapgenpse`):</strong>
                            <p>The signed certificate and CA bundle are imported into the `SAPSSLS.pse` located in the ASCS/SCS instance's `sec` folder. This PSE is critical as it's used by the Internal Web Dispatcher within the ASCS instance.</p>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash"># Assuming signed_prd_cert.crt is your signed server cert and ca_bundle.crt contains intermediates + root
cd /usr/sap/PRD/ASCS00/sec/ # Or your designated SECUDIR for ASCS
sapgenpse import_own_cert -p SAPSSLS.pse -c signed_prd_cert.crt -r ca_bundle.crt -x mypin</code></pre>
                            </div>
                        </li>
                        <li><strong>Importing Certificate into Application Server PSEs (STRUST):</strong>
                            <p>For ABAP application servers, the same signed certificate and CA bundle can be imported via transaction `STRUST`. This updates the `SAPSSLS.pse` within each application server instance's `sec` folder.</p>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash"># In STRUST:
# 1. Select "SSL Server Standard" or relevant PSE.
# 2. Click "Import Cert. Response" and select your signed_prd_cert.crt.
# 3. Add the ca_bundle.crt to the certificate list (Edit -> Certificate -> Import).
# 4. Save the PSE.
# 5. Distribute the PSE to all application servers (if not shared).</code></pre>
                            </div>
                        </li>
                        <li><strong>Importing Certificate into Independent Web Dispatcher PSE (OS Level `sapgenpse`):</strong>
                            <p>If you have independent Web Dispatcher instances, the same signed certificate and CA bundle are imported into their respective `SAPSSLS.pse` files using `sapgenpse` at the OS level.</p>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash"># On Independent Web Dispatcher host
cd /usr/sap/WDP/W01/sec/ # Or your designated SECUDIR for WD
sapgenpse import_own_cert -p SAPSSLS.pse -c signed_prd_cert.crt -r ca_bundle.crt -x mypin</code></pre>
                            </div>
                        </li>
                        <li><strong>Unified Certificate Management for SAP Java SCS/PAS Instances:</strong>
                            <p>For Java stack instances (SCS/PAS), the unified certificate approach also applies. The process involves using `sapgenpse` to manage the PSE at the OS level, then converting it to P12 format for import into NWA Key Storage.</p>
                            <ol class="list-alpha pl-5 mt-2 space-y-2">
                                <li><strong>Generate CSR via `sapgenpse` (OS Level):</strong>
                                    <p>Create a PSE and CSR for the Java instance, including relevant SANs.</p>
                                    <div class="code-block mt-2">
                                        <button class="copy-btn">Copy</button>
                                        <pre><code class="language-bash"># Example: Generate CSR for Java ASCS/PAS instance
cd /usr/sap/JPR/SCS01/sec/ # Or your designated SECUDIR for Java instance
sapgenpse get_pse -p SAPSSLS_JAVA.pse -x mypin -r jpr_java_request.csr \
-k GN-dNSName:jprjava.example.com \
-k GN-dNSName:jpr.example.com \
"CN=jprjava.example.com, OU=Java, O=MyCompany, C=US" -a RSA -s 2048</code></pre>
                                    </div>
                                </li>
                                <li><strong>Submit CSR to CA and obtain signed certificate and CA chain.</strong></li>
                                <li><strong>Import Signed Certificate via `sapgenpse` (OS Level):</strong>
                                    <p>Import the signed certificate and its full CA chain into the Java PSE.</p>
                                    <div class="code-block mt-2">
                                        <button class="copy-btn">Copy</button>
                                        <pre><code class="language-bash"># Assuming signed_jpr_java_cert.crt and ca_bundle.crt are available
cd /usr/sap/JPR/SCS01/sec/
sapgenpse import_own_cert -p SAPSSLS_JAVA.pse -c signed_jpr_java_cert.crt -r ca_bundle.crt -x mypin</code></pre>
                                    </div>
                                </li>
                                <li><strong>Verify Imported Certificate (OS Level):</strong>
                                    <div class="code-block mt-2">
                                        <button class="copy-btn">Copy</button>
                                        <pre><code class="language-bash">sapgenpse get_my_name -p SAPSSLS_JAVA.pse -v -x mypin</code></pre>
                                    </div>
                                </li>
                                <li><strong>Convert PSE to P12 format:</strong>
                                    <p>Convert the OS-level PSE to PKCS#12 format for NWA import.</p>
                                    <div class="code-block mt-2">
                                        <button class="copy-btn">Copy</button>
                                        <pre><code class="language-bash">sapgenpse export_p12 -p SAPSSLS_JAVA.pse -x mypin -z p12password SAPSSLS_JAVA.p12 -C 0</code></pre>
                                    </div>
                                </li>
                                <li><strong>Import P12 into NWA Key Storage:</strong>
                                    <p>Access NWA (`https://<java_host>:<port>/nwa`). Navigate to <strong>Configuration → Certificates and Keys → Key Storage</strong>. Select the relevant `ICM_SSL_<instance_id>` view and use "Import Entry" to import the generated `SAPSSLS_JAVA.p12` file.</p>
                                </li>
                            </ol>
                        </li>
                        <li><strong>System Restart (if not Highly Available):</strong>
                            <p>For systems that are not highly available (HA), a restart of the relevant SAP instances (ICM for ABAP, J2EE engine for Java, Web Dispatcher process) is required for the new certificates to take effect. In HA environments, rolling restarts can be performed to minimize downtime.</p>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash"># For ABAP ICM restart:
sapcontrol -nr <instance_number> -function RestartService

# For Java J2EE engine restart:
sapcontrol -nr <instance_number> -function Restart

# For Web Dispatcher restart:
sapcontrol -nr <instance_number> -function Restart</code></pre>
                            </div>
                        </li>
                    </ol>
                    <p class="mt-4">This unified approach ensures that all components handling HTTPS traffic for a given SID use the same, valid certificate, simplifying management and reducing potential trust issues.</p>
                </section>

                <!-- Section VI: RFC Gateway (Moved from V) -->
                <section id="rfc-gateway" class="content-section prose max-w-none prose-slate">
                    <h2>VI. SAP RFC Gateway: Architecture and Security</h2>
                    <p class="lead text-lg">The SAP RFC Gateway is a critical component in the SAP NetWeaver architecture, acting as a communication hub for Remote Function Calls (RFCs) between SAP systems, and between SAP and external programs. Understanding its architecture, functions, and security mechanisms is paramount for Basis consultants to ensure reliable and secure integration.</p>

                    <h3 id="rfc-overview">RFC Gateway Overview and Technical Communications</h3>
                    <p>The RFC Gateway (often referred to simply as "Gateway" or `gwrd` process) is an integral part of the SAP NetWeaver Application Server, primarily responsible for managing communication based on the RFC protocol. It acts as an intermediary, facilitating connections between:</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li>SAP application servers (ABAP to ABAP, ABAP to Java).</li>
                        <li>SAP systems and external programs (e.g., non-SAP applications, custom RFC servers).</li>
                        <li>SAP GUI and SAP application servers (though typically direct connections are used, Gateway can be involved in specific scenarios like load balancing).</li>
                    </ul>
                    <p>The Gateway is typically part of the SAP Central Services (ASCS/SCS) instance, but it can also run as a standalone instance on a separate host for specific integration scenarios or to offload processing. It listens on a specific TCP port, usually `33<instance_number>` (e.g., 3300 for instance 00, 3301 for instance 01), for incoming RFC connections.</p>
                    <p><strong>Technical Design & TCP RFCs:</strong></p>
                    <p>The RFC protocol itself operates over TCP/IP. When an RFC call is initiated, the following sequence generally occurs:</p>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li>**Connection Establishment:** An RFC client (e.g., an SAP application server, an external program) attempts to establish a TCP connection to the RFC Gateway's listening port.</li>
                        <li>**Gateway as Listener:** The Gateway continuously listens for these incoming TCP connection requests.</li>
                        <li>**Request Handling:** Upon receiving a connection, the Gateway determines the target of the RFC call. This target could be:
                            <ul class="list-disc pl-5 mt-1">
                                <li>Another SAP application server (identified by its System ID and instance number).</li>
                                <li>A registered external program (identified by its `TP_Name`).</li>
                                <li>A specific SAP program (e.g., `rfcexec`) that will then launch another external program.</li>
                            </ul>
                        </li>
                        <li>**Routing and Dispatching:** Based on its internal routing tables and configuration files (`reginfo`, `secinfo`, `ms_acl`), the Gateway routes the RFC request to the appropriate destination. It acts as a dispatcher, ensuring the request reaches the correct process or program.</li>
                        <li>**Data Exchange:** Once the connection is established and routed, the actual RFC data (function module calls, parameters, return data) is exchanged over the established TCP connection.</li>
                        <li>**Connection Termination:** After the RFC call completes, the TCP connection is terminated.</li>
                    </ol>
                    <p>The Gateway manages a pool of RFC connections and processes, ensuring efficient resource utilization and handling concurrent requests. It also provides basic load balancing capabilities for registered external programs.</p>

                    <h3 id="rfc-tp-rfcexec">TP and `rfcexec` Programs</h3>
                    <p>When an SAP system needs to execute an external program via RFC, it typically involves two key components: the `TP` (Transaction Program) and `rfcexec`.</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>TP (Transaction Program):</strong> This refers to the external program itself that is registered with the SAP Gateway. When an RFC call is made from SAP to execute an external program, the Gateway looks for a registered `TP` name. This `TP` name is a logical identifier for the external program.</li>
                        <li><strong>`rfcexec` (RFC Executable):</strong> This is a utility program provided by SAP that acts as an RFC server. Its primary function is to enable the execution of external programs by SAP systems. When `rfcexec` is started, it registers itself with the Gateway under a specific `TP` name. When the Gateway receives an RFC call for that `TP` name, it forwards the request to the `rfcexec` process, which then executes the actual external program.
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash"># Example command to start rfcexec and register it with the Gateway
rfcexec -a <TP_Name> -g <Gateway_Host> -x <Gateway_Service> -f <External_Program_Path></code></pre>
                            </div>
                            This command registers `External_Program_Path` under `TP_Name` on the specified Gateway.
                        </li>
                    </ul>
                    <p>The communication flow for external program execution via RFC is:</p>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li>An SAP application program calls an RFC-enabled function module (e.g., `RFC_CALL_PROGRAM`).</li>
                        <li>The SAP system sends an RFC request to the Gateway, specifying the `TP_Name`.</li>
                        <li>The Gateway identifies the `rfcexec` process registered for that `TP_Name`.</li>
                        <li>The Gateway forwards the request to `rfcexec`.</li>
                        <li>`rfcexec` executes the specified external program on the host where `rfcexec` is running.</li>
                        <li>The output/return code from the external program is sent back via `rfcexec` to the Gateway, and then to the SAP system.</li>
                    </ol>

                    <h3 id="rfc-security-files">Security Files (`reginfo`, `secinfo`, `prxyinfo`, `ms_acl`)</h3>
                    <p>Here's a clear, detailed breakdown of the SAP RFC Gateway—its TCP communications and the key ACL files: `reginfo`, `secinfo`, `prxyinfo`, and `ms_acl`—including correct file formats, wildcard usage, and security context.</p>

                    <h4 class="font-semibold text-slate-800 mt-4">1. RFC Gateway Architecture & TCP Communication</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li><strong>Gateway Ports:</strong> Each SAP instance has gateway services on ports `33<InstNo>` for RFC and `48<InstNo>` for RFCs with secure (SSL/TLS) connections. These are configured via OS-level service (`sapgw<nr>`) and profile parameters like `gw/acl_file`.</li>
                        <li><strong>Connection Flow:</strong>
                            <ol class="list-decimal pl-5 mt-1">
                                <li><strong>Client → Gateway:</strong> RFC client connects to gateway.</li>
                                <li><strong>`reginfo` Check:</strong> Gateway verifies via `reginfo` whether a server program can register or be accessed.</li>
                                <li><strong>Proxy (`prxyinfo`):</strong> If forwarding to another gateway, `prxyinfo` rules apply.</li>
                                <li><strong>`secinfo` Execution:</strong> For TCP/IP RFCs marked “Start on Application Server,” the gateway launches OS executables (e.g., `sapxpg`, `tp`) and checks `secinfo`.</li>
                                <li><strong>SNC (Optional):</strong> ABAP-layer SNC user/system ACLs add another security layer, managed in transaction `SNC0` or `USRACLEXT`, not gateway files.</li>
                            </ol>
                        </li>
                    </ul>

                    <h4 class="font-semibold text-slate-800 mt-4">2. `reginfo` – Registered Server Programs ACL</h4>
                    <p>Controls which external server programs can register and from where; also who can use or cancel them.</p>
                    <p><strong>Format:</strong> Recommend Version 2 syntax. Start file with:</p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-text">#VERSION=2</code></pre>
                    </div>
                    <p>Then each rule:</p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-text">P|D TP=<tp-wildcard> [HOST=<hostlist>] [ACCESS=<list>] [CANCEL=<list>]</code></pre>
                    </div>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>`P = permit, D = deny`.</li>
                        <li>`TP=` program alias (max 64 chars). Supports `*` wildcard (e.g., `foo*`, `*`).</li>
                        <li>`HOST=`, `ACCESS=`, `CANCEL=` accept hostnames (with wildcards like `*.sap.com`, `local`, `internal`) or IPs. Missing `=` “any host.”</li>
                    </ul>
                    <p><strong>Wildcards & Keywords:</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>`*` matches any chars.</li>
                        <li>`HOST=*.domain.com` matches domains.</li>
                        <li>`HOST=local` translates to gateway host’s IPs (`127.0.0.1`, `::1`, actual host IPs).</li>
                        <li>`HOST=internal` resolves to all active SAP app servers.</li>
                    </ul>
                    <p><strong>Example:</strong></p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-ini">#VERSION=2
P TP=cpict4 HOST=10.18.210.140
D TP=* HOST=10.18.210.140
P TP=cpict2 ACCESS=ld8060,localhost CANCEL=ld8060,localhost
P TP=* HOST=internal</code></pre>
                    </div>
                    <p class="mt-2 text-sm">This example:</p>
                    <ul class="list-disc pl-5 mt-1">
                        <li>Allows `cpict4` only from `10.18.210.140`.</li>
                        <li>Denies all other programs from that host.</li>
                        <li>Allows `cpict2`, but restricts access/cancel.</li>
                        <li>Allows in-system programs (`internal`).</li>
                    </ul>
                    <p class="mt-2 text-sm"><strong>Processing Order:</strong> Rules are processed sequentially from top to bottom. The first matching rule (P or D) determines the outcome. Therefore, it's a best practice to place a general `D * * * * *` rule at the *beginning* of the file to deny all by default, and then add specific `P` rules for legitimate programs.</p>

                    <h4 class="font-semibold text-slate-800 mt-4">3. `secinfo` – Start-Program ACL</h4>
                    <p>Manages which OS executables (used in Start RFCs) can be launched, by whom, and from which hosts.</p>
                    <p><strong>Format:</strong> Also Version 2:</p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-text">#VERSION=2
P|D USER=<user> USER-HOST=<hostlist> HOST=<hostlist> TP=<program-or-path></code></pre>
                    </div>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>`USER` is SAP user.</li>
                        <li>`USER-HOST`: where the RFC request originates (hostnames/IPs, wildcards, `local`, `internal`).</li>
                        <li>`HOST`: target hosts where the program runs.</li>
                        <li>`TP`: executable filename or full path. Wildcard (`*`) allowed.</li>
                    </ul>
                    <p><strong>Wildcards & Keywords:</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>`local` = localhost addresses.</li>
                        <li>`internal` = all SAP app servers.</li>
                        <li>`TP=*` allows any executable.</li>
                        <li>Note: `USER` doesn't support lists—use multiple rules.</li>
                    </ul>
                    <p><strong>Examples:</strong></p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-ini">#VERSION=2
P USER=* USER-HOST=local,internal HOST=* TP=*
P USER=sapadm USER-HOST=appserver1 HOST=localhost TP=/usr/sap/.../sapxpg</code></pre>
                    </div>
                    <p class="mt-2 text-sm">This allows all users on local or internal hosts to start any program on any host; and specifically, `sapadm` from `appserver1` to start `sapxpg` locally.</p>
                    <p class="mt-2 text-sm"><strong>Processing Order:</strong> Similar to `reginfo`, rules are processed from top to bottom. A general `D * * * * *` rule at the beginning is highly recommended, followed by specific `P` rules.</p>

                    <h4 class="font-semibold text-slate-800 mt-4">4. `prxyinfo` – Proxy ACL</h4>
                    <p>Governs RFC proxying between gateways.</p>
                    <p><strong>Format:</strong> Simplified Version 2 syntax:</p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-text">#VERSION=2
P|D SOURCE=<hostpattern> DEST=<hostpattern></code></pre>
                    </div>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>`SOURCE`: originator gateway.</li>
                        <li>`DEST`: destination gateway.</li>
                        <li>`*` defaults to allow everything when no file present.</li>
                    </ul>
                    <p><strong>Use Case:</strong> Allows control over which systems can relay RFC through this gateway.</p>
                    <p><strong>Example:</strong></p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-ini">#VERSION=2
P SOURCE=gateway1.example.com DEST=gateway2.example.com
D SOURCE=* DEST=*</code></pre>
                    </div>

                    <h4 class="font-semibold text-slate-800 mt-4">5. `ms_acl` – Message Server ACL (SAP Message Server context)</h4>
                    <p>Similar to gateway ACLs but applies to message server for load balancing and inter-node communication. Governs which instances or hosts can connect to the message server.</p>
                    <p><strong>Purpose:</strong> The `ms_acl` file enhances the security of the Message Server by restricting access to authorized hosts only. This prevents unauthorized systems from querying the Message Server for application server lists or attempting to register as an application server, which could lead to denial-of-service attacks or unauthorized access.</p>
                    <p><strong>Format:</strong> Managed via parameter `ms/acl_file`, format akin to `reginfo`/`secinfo`—beginning `#VERSION=2`, using `P|D HOST=` rules.</p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-text">#VERSION=2
P|D HOST=<hostpattern></code></pre>
                    </div>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>Supports wildcards (`*`, domain-globs) and `local`|`internal` keywords.</li>
                        <li>Ensures only authorized applications/nodes join message-group communication sessions.</li>
                    </ul>
                    <p><strong>Example:</strong></p>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-ini">#VERSION=2
P HOST=localhost
P HOST=*.sap.internal
D HOST=*</code></pre>
                    </div>
                    <p class="mt-2 text-sm"><strong>Location:</strong> The `ms_acl` file is typically located in the Message Server's working directory (e.g., `usr/sap/<SID>/<Instance>/work`).</p>

                    <h4 class="font-semibold text-slate-800 mt-4">6. Managing & Best Practices</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-2">
                        <li>Always declare `#VERSION=2`, manually or via transaction `SMGW → Expert → External Security`, to use full syntax.</li>
                        <li>Put specific rules first, then general rules (e.g., `local` and `internal`) at the end; evaluation stops at first match.</li>
                        <li>Set `gw/acl_mode = 1` so only ACL-defined rules apply; else default is “allow all”.</li>
                        <li>Use simulation mode (`gw/sim_mode = 1`) and gateway logging to identify needed rules before enforcement.</li>
                        <li>Ensure hostname resolution is accurate—misconfigured DNS means rule lines are ignored.</li>
                    </ul>

                    <h4 class="font-semibold text-slate-800 mt-4">Summary Table</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse mt-4">
                            <thead>
                                <tr>
                                    <th class="border-b-2 p-2 bg-slate-50 font-semibold">File</th>
                                    <th class="border-b-2 p-2 bg-slate-50 font-semibold">Controls</th>
                                    <th class="border-b-2 p-2 bg-slate-50 font-semibold">Format Version 2 Syntax</th>
                                    <th class="border-b-2 p-2 bg-slate-50 font-semibold">Wildcards & Keywords</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="p-2"><code>reginfo</code></td>
                                    <td class="p-2">Server registration/access</td>
                                    <td class="p-2">`P|D TP=<...> [HOST=<hostlist>] [ACCESS=<list>] [CANCEL=<list>]`</td>
                                    <td class="p-2">`*`, `foo*`, `*.domain`, `local`, `internal`</td>
                                </tr>
                                <tr class="border-b bg-white">
                                    <td class="p-2"><code>secinfo</code></td>
                                    <td class="p-2">Program start authorization</td>
                                    <td class="p-2">`P|D USER=<user> USER-HOST=<hostlist> HOST=<hostlist> TP=<program-or-path>`</td>
                                    <td class="p-2">Same wildcards & keywords as above</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-2"><code>prxyinfo</code></td>
                                    <td class="p-2">RFC proxy authorization</td>
                                    <td class="p-2">`P|D SOURCE=<hostpattern> DEST=<hostpattern>`</td>
                                    <td class="p-2">`*`, host names, IP patterns</td>
                                </tr>
                                <tr class="border-b bg-white">
                                    <td class="p-2"><code>ms_acl</code></td>
                                    <td class="p-2">Message server connectivity</td>
                                    <td class="p-2">`P|D HOST=<hostpattern> [other attributes]`</td>
                                    <td class="p-2">Same wildcards & keywords as above</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4 class="font-semibold text-slate-800 mt-4">Bringing it all together</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>Gateway listens on TCP ports `33xx`/`48xx`.</li>
                        <li>RFC registration or proxy request arrives → check `reginfo` then `prxyinfo`.</li>
                        <li>Start request (TCP RFC) → check `secinfo`, then execute program.</li>
                        <li>Message server communications rely on `ms_acl`.</li>
                        <li>Higher-level security via SNC user/system access control as needed.</li>
                    </ul>

                    <h4 class="font-semibold text-slate-800 mt-4">Related Profile Parameters for RFC Gateway Security</h4>
                    <p>Several SAP profile parameters also influence RFC Gateway security:</p>
                    <ul class="list-disc pl-5 mt-2 space-y-2">
                        <li>`gw/acl_mode`: Controls whether the `reginfo` and `secinfo` files are active (`1`) or inactive (`0`). Set to `1` for production systems.</li>
                        <li>`gw/reg_info`: Specifies the path to the `reginfo` file.</li>
                        <li>`gw/sec_info`: Specifies the path to the `secinfo` file.</li>
                        <li>`gw/prxy_info`: Specifies the path to the `prxyinfo` file.</li>
                        <li>`gw/rem_start`: Controls whether external programs can be started remotely via the Gateway. Set to `0` to disable remote starts unless absolutely necessary and explicitly controlled by `secinfo`.</li>
                        <li>`gw/cpic_security`: Enhances security for CPIC connections.</li>
                    </ul>
                    <p class="mt-4"><strong>Conclusion:</strong> By structuring ACLs in Version 2 with ordered rules, wildcards, and proper use of `local`/`internal`, you gain tight control over:</p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>Which servers/apps can register.</li>
                        <li>Which RFCs can proxy.</li>
                        <li>Which OS executables can run via gateway.</li>
                        <li>Which hosts nodes can join the message server.</li>
                    </ul>
                </section>

                <!-- Section VII: SNC SSO (Moved from VI) -->
                <section id="snc-sso" class="content-section prose max-w-none prose-slate">
                    <h2>VII. Secure Network Communications (SNC) & SSO</h2>
                    <p class="lead text-lg">Secure Network Communications (SNC) provides an application-level security layer for SAP systems, enabling encryption and single sign-on (SSO) for various SAP components. It's crucial for securing internal SAP communication and integrating with enterprise identity management solutions like Microsoft Active Directory.</p>

                    <h3 id="snc-overview">SNC Overview</h3>
                    <p>SNC is a software layer in the SAP system architecture that provides security functions such as authentication, encryption, and data integrity for communication between SAP components (e.g., SAP GUI to ABAP, ABAP to ABAP RFC, ABAP to Java) and between SAP systems and external applications.</p>
                    <p>SNC uses an external security product (like CommonCryptoLib, or third-party GSS-API compliant products) to provide these security services. It operates at the application layer, meaning it secures the data *before* it is passed to the network layer, providing end-to-end security within the SAP landscape.</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>Authentication:</strong> Verifies the identity of communication partners.</li>
                        <li><strong>Data Integrity:</strong> Ensures that data has not been tampered with during transmission.</li>
                        <li><strong>Data Privacy (Encryption):</strong> Protects data from unauthorized viewing.</li>
                        <li><strong>Single Sign-On (SSO):</strong> Allows users to log into SAP systems without re-entering credentials, leveraging existing enterprise authentication mechanisms (e.g., Kerberos with Active Directory).</li>
                    </ul>

                    <h3 id="snc-config">SNC Configuration Steps</h3>
                    <p>Configuring SNC involves several steps, including setting up the cryptographic library, generating PSEs, and configuring profile parameters.</p>
                    <h4 class="font-semibold text-slate-800 mt-4">Prerequisites:</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>CommonCryptoLib (or other GSS-API compliant security product) installed.</li>
                        <li>`SECUDIR` environment variable correctly set.</li>
                        <li>SNC license (if using a third-party product).</li>
                    </ul>
                    <h4 class="font-semibold text-slate-800 mt-4">Key Configuration Steps:</h4>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li><strong>Generate SNC PSEs:</strong> Use `sapgenpse` to create `SAPSNCS.pse` for the SAP application server. This PSE will hold the server's identity for SNC.
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">sapgenpse get_pse -p SAPSNCS.pse -x <PIN> "CN=<SAPServiceSID>,OU=<OrgUnit>,O=<Org>,C=<Country>"</code></pre>
                            </div>
                            The Common Name (CN) for SNC PSEs typically follows the format `CN=<SAPServiceSID>`, which is the service user under which the SAP instance runs.
                        </li>
                        <li><strong>Create `cred_v2` file:</strong> This file allows the SAP system OS user to access the SNC PSE without a PIN.
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">sapgenpse seclogin -p SAPSNCS.pse -x <PIN> -O <sidadm></code></pre>
                            </div>
                        </li>
                        <li><strong>Configure Profile Parameters (RZ10):</strong>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">snc/enable = 1                 # Enable SNC
snc/gssapi_lib = /usr/sap/<SID>/SYS/exe/run/libsapcrypto.so  # Path to CryptoLib
snc/identity/as = p:<SNC_Name_of_AS_PSE> # e.g., p:CN=SAPServiceSID@DOMAIN.COM
snc/data_protection/max = 3    # Max protection level (1:auth, 2:integrity, 3:privacy)
snc/data_protection/min = 2    # Min protection level
snc/accept_insecure_cpic = 0   # Do not accept insecure CPIC connections
snc/accept_insecure_rfc = 0    # Do not accept insecure RFC connections
snc/accept_insecure_gui = 0    # Do not accept insecure GUI connections
snc/permit_insecure_start = 0  # Do not permit insecure program starts
login/create_sso_ticket = 1    # Enable SSO ticket creation
login/accept_sso_ticket = 1    # Accept SSO tickets
                                </code></pre>
                            </div>
                        </li>
                        <li><strong>Import Certificates (if using PKI-based SNC):</strong> If SNC is based on X.509 certificates (e.g., for system-to-system authentication), relevant trusted certificates must be imported into the `SAPSNCS.pse` using `sapgenpse maintain_pk`.</li>
                        <li><strong>Restart SAP System:</strong> A full SAP system restart is usually required for SNC profile parameters to take effect.</li>
                    </ol>

                    <h3 id="snc-ad-sso">SNC with Active Directory for SSO</h3>
                    <p>Integrating SNC with Microsoft Active Directory (AD) enables Single Sign-On (SSO) for SAP GUI users, leveraging Kerberos authentication. This allows users to log into SAP without re-entering their credentials, using their existing Windows login.</p>
                    <h4 class="font-semibold text-slate-800 mt-4">Key Concepts for AD Integration:</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-2">
                        <li><strong>Kerberos:</strong> The primary authentication protocol used in Active Directory for SSO. SNC products (like CommonCryptoLib) can act as a GSS-API wrapper for Kerberos.</li>
                        <li><strong>Service Principal Name (SPN):</strong> A unique identifier for a service instance that is used by Kerberos authentication. For SAP, SPNs are registered for the SAP application server service user in Active Directory.</li>
                        <li><strong>Delegation:</strong> If the SAP system needs to access other services on behalf of the user (e.g., for RFC calls), Kerberos delegation might be required.</li>
                    </ul>
                    <h4 class="font-semibold text-slate-800 mt-4">Configuration Steps for AD SSO:</h4>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li><strong>Create a Service User in AD:</strong> Create a dedicated Active Directory user account (e.g., `SAPService<SID>`) that will run the SAP instance. This user must have the "Password never expires" and "Account is trusted for delegation" (if delegation is needed) properties set.</li>
                        <li><strong>Register SPN for SAP Service User:</strong> Use the `setspn` command-line tool on a Domain Controller to register the Service Principal Name (SPN) for the SAP service user. This links the SAP service to the AD user account.
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">setspn -S SAP/<SAP_Service_Name> <Domain>\<SAPServiceSID>
setspn -S SAP/<FQDN_of_SAP_Host> <Domain>\<SAPServiceSID>

# Example:
# setspn -S SAP/SAP_ERP_DEV DEV\SAPServiceDEV
# setspn -S SAP/erpdev.domain.com DEV\SAPServiceDEV</code></pre>
                            </div>
                            The `SAP_Service_Name` is typically `SAP/<SID>` or `SAP/<SID>/<instance_number>`. The FQDN is crucial for Kerberos.
                        </li>
                        <li><strong>Verify SPN Registration:</strong>
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash"># Query SPNs registered for a specific user:
setspn -L <Domain>\<SAPServiceSID>

# Query for a specific SPN to see which account it's registered to:
setspn -Q SAP/<SAP_Service_Name></code></pre>
                            </div>
                        </li>
                        <li><strong>Generate Kerberos Keytab (if using Kerberos directly):</strong> Some SNC products might require a Kerberos keytab file.</li>
                        <li><strong>Configure SAP GUI for SNC:</strong>
                            <ul class="list-disc pl-5 mt-1">
                                <li>In SAP Logon, go to the entry for the SAP system.</li>
                                <li>In the "Network" tab, select "Activate Secure Network Communications."</li>
                                <li>Specify the "SNC Name" of the application server (e.g., `p:CN=SAPServiceSID@DOMAIN.COM`).</li>
                                <li>Specify the "SNC Library" path (e.g., `C:\Program Files\SAP\FrontEnd\sapgui\gsskrb5.dll`).</li>
                            </ul>
                        </li>
                        <li><strong>Map AD Users to SAP Users:</strong> In SAP (transaction `SU01`), for each user, go to the "SNC" tab and map the AD user's SNC name (e.g., `p:CN=<AD_User_Name>@DOMAIN.COM`) to their SAP user.</li>
                        <li><strong>Test SSO:</strong> Log in to Windows with an AD user and then launch SAP GUI. If configured correctly, the user should be logged in automatically without a password.</li>
                    </ol>
                    <p class="mt-4"><strong>Practical Exercise:</strong> In a test AD environment, create a service user, register an SPN using `setspn`, and configure SNC in an SAP ABAP system. Test SSO from an SAP GUI client and troubleshoot any Kerberos errors using tools like `klist` or `setspn -Q`.</p>
                </section>
                
                 <!-- Section VIII: Web Services (Moved from VIII) -->
                <section id="web-services" class="content-section prose max-w-none prose-slate">
                    <h2>VIII. SAP Web Services and ICM Services</h2>
                    <p class="lead text-lg">SAP systems leverage various services and tools to enable web-based communication and integrate with other systems. Understanding the roles of SICF, SOAMANAGER, SPROXY, and the `HTTPURLLOC` table is crucial for Basis consultants managing modern SAP landscapes.</p>

                    <h3 id="sicf">SICF (Internet Communication Framework)</h3>
                    <p>The **Internet Communication Framework (ICF)** is a fundamental component of the SAP NetWeaver Application Server (ABAP stack) that enables HTTP, HTTPS, and SMTP communication. **SICF (Service Creation and Maintenance)** is the transaction code used to manage and activate ICF services.</p>
                    <p><strong>What it is:</strong> SICF acts as a central registry for all HTTP(S) services provided by the ABAP stack. These services can be anything from web dynpro applications, OData services for Fiori, SOAP web services, or custom HTTP handlers. Each service in SICF corresponds to a specific URL path and is associated with an ABAP class that handles the incoming requests.</p>
                    <p><strong>Functions:</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li><strong>Service Activation/Deactivation:</strong> Administrators can activate or deactivate individual ICF services or entire branches of services (e.g., `/sap/public`, `/sap/bc`). Only active services can be accessed via HTTP(S).</li>
                        <li><strong>URL Mapping:</strong> Defines the URL path (e.g., `/sap/bc/bsp/sap/it00`) that maps to a specific ABAP handler class.</li>
                        <li><strong>Authentication Configuration:</strong> Configures authentication methods for services (e.g., Basic Authentication, Client Certificate, SSO).</li>
                        <li><strong>Error Page Configuration:</strong> Customizes error pages displayed to users for specific services.</li>
                        <li><strong>Service User Assignment:</strong> Assigns a service user to a service for background processing or specific authorizations.</li>
                        <li><strong>Load Balancing:</strong> Helps in distributing requests to different application servers.</li>
                    </ul>
                    <p><strong>Basis Maintenance:</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>Activating and deactivating standard and custom ICF services as per application requirements.</li>
                        <li>Troubleshooting HTTP 404 (Not Found) errors (often due to inactive services).</li>
                        <li>Configuring authentication methods and ensuring proper user mapping.</li>
                        <li>Maintaining service users and their authorizations.</li>
                        <li>Ensuring services are exposed via the correct hostnames and ports (often in conjunction with ICM and Web Dispatcher).</li>
                    </ul>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-bash"># Example: Activating a service in SICF
# 1. Go to transaction SICF.
# 2. Navigate to the service path (e.g., /sap/bc/bsp/sap/it00).
# 3. Right-click on the service and choose "Activate Service".
# 4. Confirm activation of sub-nodes if prompted.</code></pre>
                    </div>

                    <h3 id="soamanager-sproxy">SOAMANAGER and SPROXY (Web Services Management)</h3>
                    <p>These transactions are central to managing and consuming **SOAP-based Web Services** in SAP ABAP systems.</p>
                    <p><strong>SOAMANAGER (SOA Management):</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li><strong>What it is:</strong> A web-based tool (accessed via a browser URL) for configuring, publishing, and monitoring Web Services and Service Consumers in the ABAP stack. It is the successor to the older WSCONFIG/WSADMIN transactions.</li>
                        <li><strong>Functions:</strong>
                            <ul>
                                <li>Configuring service endpoints (URLs, authentication, security settings).</li>
                                <li>Publishing services to a Service Registry (e.g., SAP NetWeaver Process Orchestration).</li>
                                <li>Testing Web Services.</li>
                                <li>Monitoring Web Service calls (logging, error analysis).</li>
                            </ul>
                        </li>
                        <li><strong>Basis Maintenance:</strong>
                            <ul>
                                <li>Creating and maintaining logical ports for service consumers (defining which external Web Service to call and how).</li>
                                <li>Configuring security settings for Web Services (e.g., SSL client certificates, user authentication).</li>
                                <li>Troubleshooting connectivity issues between SAP and external Web Services.</li>
                                <li>Ensuring correct WSDL (Web Services Description Language) import and configuration.</li>
                            </ul>
                        </li>
                    </ul>

                    <p><strong>SPROXY (Proxy Generation):</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li><strong>What it is:</strong> An ABAP Workbench transaction used to generate ABAP proxy objects from WSDL (Web Services Description Language) definitions. These proxy objects allow ABAP programs to consume external Web Services or expose ABAP functionalities as Web Services.</li>
                        <li><strong>Functions:</strong>
                            <ul>
                                <li>Generates ABAP classes and interfaces that represent the structure and operations of a Web Service.</li>
                                <li>Simplifies the integration of Web Services into ABAP applications by abstracting the complexities of SOAP communication.</li>
                            </ul>
                        </li>
                        <li><strong>Basis Maintenance:</strong>
                            <ul>
                                <li>Ensuring the connection to the Enterprise Services Repository (ESR) or external WSDL URLs is working.</li>
                                <li>Assisting developers with WSDL import and proxy generation issues.</li>
                                <li>Verifying that generated proxies correctly reflect the Web Service definition.</li>
                            </ul>
                        </li>
                    </ul>

                    <h3 id="httpurlloc">HTTPURLLOC Table and its Purpose</h3>
                    <p>The `HTTPURLLOC` table is a crucial configuration table in SAP ABAP systems that stores the **external URLs** used by the system for various purposes, particularly for generating URLs that are accessed by external clients or systems. It plays a significant role in ensuring that SAP generates correct and accessible URLs, especially in complex landscapes involving Web Dispatchers or reverse proxies.</p>
                    <p><strong>Purpose:</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li><strong>URL Generation:</strong> When an SAP system needs to generate a URL that points back to itself (e.g., for a Fiori Launchpad link, a Web Dynpro application link, or a callback URL for an external service), it consults the `HTTPURLLOC` table.</li>
                        <li><strong>External Accessibility:</strong> It ensures that the generated URLs are externally accessible and correctly route through any intervening network components like Web Dispatchers, firewalls, or load balancers. Without correct entries in `HTTPURLLOC`, SAP might generate internal hostnames or HTTP URLs when an external HTTPS URL is expected, leading to broken links or security warnings.</li>
                        <li><strong>Protocol and Port Control:</strong> The table specifies the protocol (HTTP or HTTPS), the external hostname, and the external port that should be used when generating URLs for a given SAP client and service.</li>
                        <li><strong>Virtual Host Mapping:</strong> In scenarios with virtual hostnames or multiple entry points to the same SAP system, `HTTPURLLOC` helps map internal SAP services to their publicly exposed URLs.</li>
                    </ul>
                    <p><strong>Key Fields in `HTTPURLLOC` (Simplified):</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>`CLIENT`: The SAP client for which the URL is defined.</li>
                        <li>`PROT`: Protocol (e.g., `HTTPS`, `HTTP`).</li>
                        <li>`HOST`: The external hostname (e.g., `fiori.mycompany.com`).</li>
                        <li>`PORT`: The external port (e.g., `443`, `80`).</li>
                        <li>`SORT_KEY`: Used to prioritize entries if multiple matching entries exist.</li>
                        <li>`PATH_PREFIX`: Optional path prefix for the URL.</li>
                    </ul>
                    <p><strong>Basis Maintenance:</strong></p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>Maintaining correct entries in `HTTPURLLOC` is critical for Fiori deployments, Web Dynpro applications, and any scenario where SAP generates URLs for external consumption.</li>
                        <li>Incorrect entries are a common cause of broken links, redirection issues, and mixed content warnings (HTTP content on an HTTPS page).</li>
                        <li>Changes to network architecture (e.g., new Web Dispatcher, hostname changes) often require updates to this table.</li>
                        <li>The table can be maintained via transaction `SM30` for view `V_HTTP_LOC`.</li>
                    </ul>
                    <div class="code-block mt-2">
                        <button class="copy-btn">Copy</button>
                        <pre><code class="language-bash"># Example: Entry in HTTPURLLOC for Fiori Launchpad
# CLIENT: 100
# PROT: HTTPS
# HOST: fiori.mycompany.com
# PORT: 443
# SORT_KEY: 001
# PATH_PREFIX: /sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html

# This ensures that when SAP generates a link to the Fiori Launchpad for client 100,
# it uses https://fiori.mycompany.com/sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html</code></pre>
                    </div>
                </section>

                <!-- Section IX: Advanced Topics (Moved from IX) -->
                <section id="advanced-topics" class="content-section prose max-w-none prose-slate">
                     <h2>IX. Advanced Topics</h2>
                     <p class="lead text-lg">Beyond basic configuration, advanced topics in SAP SSL/TLS management include integrating with Hardware Security Modules (HSMs) for enhanced key protection, optimizing performance for high-volume systems, and adhering to comprehensive security best practices.</p>

                    <h3 id="advanced-hsm" class="mt-8">Hardware Security Module (HSM) Integration</h3>
                    <p>CommonCryptoLib supports HSMs for secure private key storage and cryptographic operations, significantly enhancing security posture for critical SAP systems. HSMs protect private keys from software-based attacks and provide FIPS-compliant hardware security.</p>
                    <h4 class="font-semibold text-slate-800 mt-4">Configuration Steps:</h4>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li>Install HSM client software on SAP servers (e.g., SafeNet, Thales).</li>
                        <li>Configure CommonCryptoLib to interface with HSM via profile parameters:
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">ssl/pse_provider = <HSM_vendor_library_name> # e.g., "SafeNet"
ssl/hsm_device = <device_name> # e.g., "token_name"</code></pre>
                            </div>
                        </li>
                        <li>Generate keys directly in the HSM and import certificates into the PSE using `sapgenpse`.</li>
                        <li>Verify HSM integration: `sapgenpse get_my_name -p SAPSSLS.pse -v` (output should indicate HSM usage).</li>
                    </ol>

                    <h3 id="advanced-performance" class="mt-8">Performance Optimization</h3>
                    <p>Optimizing SSL/TLS performance is crucial for high-volume SAP systems. Key strategies include:</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>Cipher Suite Selection:</strong> Prioritize modern, efficient cipher suites like those using ECDHE (Elliptic Curve Diffie-Hellman Ephemeral) for key exchange and AES-GCM for encryption (e.g., `TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384`). These offer strong security with better performance than older RSA-based key exchanges.</li>
                        <li><strong>Session Tickets/Resumption:</strong> Enable TLS session tickets (RFC 5077) or session resumption to reduce handshake overhead for subsequent connections. This allows clients and servers to quickly re-establish a secure session without a full handshake.
                            <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-bash">ssl/session_tickets = 1 # In ICM profile parameters</code></pre>
                            </div>
                        </li>
                        <li><strong>Hardware Acceleration:</strong> Leverage hardware acceleration features, such as Intel AES-NI instructions or dedicated Hardware Security Modules (HSMs), to offload cryptographic operations from the CPU.</li>
                        <li><strong>Web Dispatcher Pooling:</strong> For Web Dispatcher, enable connection pooling for SSL re-encryption using `wdisp/HTTP/use_pool_for_new_conn = 1` to reuse established backend connections.</li>
                    </ul>

                    <h3 id="advanced-best-practices" class="mt-8">Security Best Practices</h3>
                    <p>Maintaining a strong SSL/TLS security posture in SAP requires continuous vigilance and adherence to best practices:</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>Enforce Modern TLS Versions:</strong> Actively disable older, vulnerable TLS versions (TLS 1.0/1.1) and weak cipher suites (e.g., those using CBC mode, MD5, RC4, 3DES). Prioritize TLS 1.2 and 1.3 where supported by SAP kernel and CommonCryptoLib.</li>
                        <li><strong>Regular Updates:</strong> Keep CommonCryptoLib and SAP kernel up-to-date by regularly applying relevant SAP Notes (e.g., <a href="https://launchpad.support.sap.com/#/notes/2809914" target="_blank" class="text-blue-600 hover:underline">SAP Note 2809914</a>) to benefit from security fixes and new features.</li>
                        <li><strong>Monitor Certificate Expiration:</strong> Implement robust monitoring (e.g., SAP Solution Manager, custom scripts) to alert well in advance of certificate expiration.</li>
                        <li><strong>Mutual TLS (Client Authentication):</strong> Implement mutual TLS for sensitive RFCs and APIs to provide stronger authentication by requiring both client and server to present and verify certificates.</li>
                        <li><strong>Secure PSEs:</strong> Backup PSEs securely and restrict access to the `SECUDIR` directory with strict file system permissions (`chmod 600`).</li>
                        <li><strong>Regular Audits:</strong> Conduct regular security audits of SSL/TLS configurations to identify and remediate vulnerabilities.</li>
                    </ul>
                </section>

                <!-- Section X: Troubleshooting & Diagnostics (Moved from X) -->
                <section id="troubleshooting-final" class="content-section prose max-w-none prose-slate">
                     <h2>X. Troubleshooting & Diagnostics</h2>
                     <p class="lead text-lg">Effective troubleshooting of SSL/TLS issues in SAP environments requires a systematic approach and a deep understanding of common error patterns. This module equips consultants with the knowledge to diagnose and resolve frequently encountered problems across SAP ABAP, Java, and Web Dispatcher environments.</p>

                    <h3 id="troubleshooting-common" class="mt-8">Common SSL/TLS Issues and Resolutions</h3>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>Certificate Expired, Inactive, or Untrusted</strong>:
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li><strong>Symptom:</strong> Browser errors like "Your connection is not private", `NET::ERR_CERT_DATE_INVALID`, or `SSL Peer Certificate Untrusted` in SAP logs.</li>
                                <li><strong>Cause:</strong> Certificate has expired, is not yet valid, or its issuing CA is not trusted by the client/SAP system. Incomplete certificate chain.</li>
                                <li><strong>Solution:</b> Renew promptly. Verify validity dates and synchronize system clocks. Import the <strong>entire CA chain</strong> (intermediate and root certificates) into relevant trust stores (STRUST for ABAP, NWA Key Storage for Java). Use `sapgenpse maintain_pk -a <cert_file>` to add missing CAs.</li>
                            </ul>
                        </li>
                        <li><strong>Certificate Name Mismatches (Common Name vs. SANs)</strong>:
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li><strong>Symptom:</strong> Browser errors like "Certificate name mismatch" or "NET::ERR_CERT_COMMON_NAME_INVALID."</li>
                                <li><strong>Cause:</strong> Hostname/IP used to access the server does not match the CN or any SANs in the certificate.</li>
                                <li><strong>Solution:</strong> When generating CSR, ensure all relevant hostnames/IPs are included as SANs (`sapgenpse gen_pse -k GN-dNSName:<SAN>`). Verify FQDN configuration in STRUST/NWA.</li>
                            </ul>
                        </li>
                        <li><strong>Handshake Failure</strong>:
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li><strong>Symptom:</strong> Connection fails at the handshake stage.</li>
                                <li><strong>Cause:</strong> Mismatched TLS versions or cipher suites between client and server.</li>
                                <li><strong>Solution:</strong> Verify `ssl/ciphersuites` and TLS version compatibility in ICM logs (`dev_icm`). Example log check:
                                    <div class="code-block mt-2">
                                        <button class="copy-btn">Copy</button>
                                        <pre><code class="language-bash">cat /usr/sap/<SID>/<Instance>/work/dev_icm | grep SSL</code></pre>
                                    </div>
                                </li>
                            </ul>
                        </li>
                        <li><strong>PSE Access Errors</strong>:
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li><strong>Symptom:</strong> SAP services fail to start or report errors accessing PSE.</li>
                                <li><strong>Cause:</strong> Incorrect file permissions in SECUDIR, invalid PSE PIN, or missing `cred_v2` file.</li>
                                <li><strong>Solution:</strong> Ensure correct permissions in SECUDIR (`chmod 600`, `chown <sidadm>:sapsys`). Verify PSE PIN. Use `sapgenpse seclogin -p <PSE_name> -O <OS_user>` to configure password-free access.</li>
                            </ul>
                        </li>
                        <li><strong>TLS Alert Codes</strong>:
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                <li><strong>Symptom:</strong> Specific alert codes in logs (e.g., `handshake_failure (40)`, `certificate_unknown (46)`, `decrypt_error (50)`).</li>
                                <li><strong>Cause:</strong> Indicates specific points of failure during the handshake.</li>
                                <li><strong>Solution:</strong> Analyze the alert code in Wireshark traces or ICM logs to pinpoint the exact issue and apply targeted solutions (e.g., missing CA, incorrect key, protocol mismatch).</li>
                            </ul>
                        </li>
                    </ul>

                    <h3 id="troubleshooting-llm" class="mt-8">✨ SSL Troubleshooting Assistant</h3>
                    <p>Describe an SSL/TLS error or scenario you are facing, and the Gemini API will provide possible causes and solutions relevant to SAP environments.</p>
                    <div class="bg-white p-6 rounded-lg border border-stone-200 mt-4 not-prose">
                        <textarea id="troubleshooting-prompt" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-teal-500 focus:border-transparent min-h-[120px]" placeholder="e.g., We are getting 'SSL handshake failed' errors when connecting from our ABAP system to an external REST API."></textarea>
                        <button id="troubleshoot-btn" class="mt-2 bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700 transition">Get Solutions ✨</button>
                        <div id="troubleshooting-output" class="mt-4 p-4 border rounded-lg bg-gray-50 hidden">
                            <!-- Output will be injected here -->
                        </div>
                        <div id="troubleshooting-loading" class="text-center p-4 hidden">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-900 mx-auto"></div>
                            <p class="mt-2">Analyzing problem...</p>
                        </div>
                    </div>
                </section>

                <!-- Section XI: Conclusion (Moved from XI) -->
                <section id="conclusion" class="content-section prose max-w-none prose-slate">
                    <h2>XI. Conclusions and Recommendations</h2>
                    <p class="lead text-lg">The comprehensive analysis of SSL/TLS certificates for professional SAP Basis consultants reveals a critical landscape where foundational cryptographic principles intersect with complex, platform-specific implementations. The training presented in this application aims to equip consultants with not only the theoretical knowledge but also the practical expertise necessary to navigate this intricate domain.</p>

                    <p>Several key areas warrant particular attention and form the basis of actionable recommendations:</p>
                    <ol class="list-decimal pl-5 mt-4 space-y-2">
                        <li><strong>Embrace TLS, Discard SSL Terminology:</strong> The persistent use of "SSL" as a generic term, despite the deprecation of the actual SSL protocol, can lead to significant security vulnerabilities if outdated configurations are inadvertently maintained. It is recommended that all future discussions and documentation explicitly differentiate between SSL and TLS, consistently emphasizing the use of modern TLS versions (1.2 and especially 1.3) to ensure robust security. This linguistic precision is a foundational step towards a more secure operational posture.</li>
                        <li><strong>Prioritize Continuous Cryptographic Modernization:</strong> The rapid evolution of cryptographic algorithms and protocols, driven by emerging threats like quantum computing, means that security configurations are not static. It is recommended that SAP Basis teams establish a proactive strategy for continuous monitoring and evaluation of new TLS standards and cryptographic algorithms. Regular review of SAP Notes for recommended CommonCryptoLib versions and timely upgrades are crucial to stay ahead of potential compromises and ensure long-term system resilience.</li>
                        <li><strong>Master the `sapgenpse` Tool for Automation:</strong> The command-line nature of `sapgenpse` presents a significant opportunity for automating routine certificate management tasks. It is recommended that consultants develop and implement automated scripts for CSR generation, certificate import, renewal processes, and `seclogin` credential management. This automation will significantly reduce manual errors, streamline operations, and ensure proactive certificate lifecycle management across the SAP landscape.</li>
                        <li><strong>Adopt a Holistic View of SAP Security:</strong> SAP's security components are deeply interconnected. A misconfiguration or outdated component in one area (e.g., CommonCryptoLib version, `SECUDIR` path) can have cascading effects across ABAP, Java, and Web Dispatcher environments. It is recommended that Basis consultants adopt a holistic perspective, understanding how changes in one area impact the entire ecosystem. This necessitates a systematic troubleshooting approach that considers the full stack, rather than isolated components.</li>
                        <li><strong>Leverage SAP Web Dispatcher as a Strategic Security Gateway:</strong> The SAP Web Dispatcher's capabilities for SSL/TLS termination and re-encryption make it a powerful security component. It is recommended to strategically deploy the Web Dispatcher to enforce modern TLS versions and strong cipher suites at the network edge, thereby protecting backend SAP systems. This allows for a phased adoption of newer TLS standards (e.g., TLS 1.3), enabling organizations to enhance external security without immediately overhauling all backend systems. Careful configuration of parameters like `wdisp/ssl_encrypt` and `wdisp/HTTP/use_pool_for_new_conn` is essential to balance security with performance.</li>
                        <li><strong>Implement Meticulous Certificate Lifecycle Management:</strong> The operational burden of manual certificate renewal and the risks associated with expired or untrusted certificates are substantial. It is recommended to implement rigorous certificate lifecycle management practices, including proactive monitoring of expiration dates, adherence to the principle of generating new key pairs for renewals (re-keying) for critical systems, and meticulous import of full certificate chains. Understanding and correctly configuring Certificate Revocation Lists (CRLs) is also vital, especially with the industry's shift away from OCSP due to privacy concerns.</li>
                    </ol>
                </section>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.querySelectorAll('#navigation-menu a');
    const contentSections = document.querySelectorAll('.content-section');

    function navigateTo(hash) {
        // Determine the target element, which could be a main section or a sub-heading within a section
        const targetElement = hash ? document.querySelector(hash) : document.querySelector('#cover-page'); // Default to cover page
        if (!targetElement) {
            // Fallback to cover page if hash is invalid
            document.querySelector('#cover-page').classList.add('active');
            navLinks.forEach(link => {
                if (link.getAttribute('href') === '#cover-page') {
                    link.classList.add('active');
                }
            });
            return;
        }

        // Find the main content section that contains the target element
        let mainContentSection = targetElement.closest('.content-section');
        if (!mainContentSection) {
            // If the target is itself a content-section
            mainContentSection = targetElement;
        }

        // Deactivate all sections and links
        contentSections.forEach(section => section.classList.remove('active'));
        navLinks.forEach(link => link.classList.remove('active'));

        // Activate the determined main content section
        mainContentSection.classList.add('active');

        // Activate the corresponding nav link(s)
        navLinks.forEach(link => {
            if (link.getAttribute('href') === hash) {
                link.classList.add('active');
            }
            // Also activate the parent main nav link if a sub-link is clicked
            // Corrected: Use mainContentSection.id instead of undefined parentContentSectionId
            if (link.getAttribute('href') === `#${mainContentSection.id}`) {
                link.classList.add('active');
            }
        });

        // Let the browser handle the scroll to the specific hash ID
        if (hash && targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const hash = this.getAttribute('href');
            window.history.pushState(null, '', hash); // Update URL without full reload
            navigateTo(hash);
        });
    });

    // Handle initial load and back/forward button
    window.addEventListener('popstate', () => {
        navigateTo(window.location.hash);
    });

    // Initial load
    navigateTo(window.location.hash || '#cover-page'); // Default to cover page if no hash

    // Handshake visualization logic (updated with more steps)
    let currentHandshakeStep = -1; // Start at -1 to show nothing initially
    const handshakeMessages = document.querySelectorAll('.handshake-message');
    const handshakeExplanation = document.getElementById('handshake-explanation');
    const handshakeBtn = document.getElementById('handshake-btn');
    const handshakeResetBtn = document.getElementById('handshake-reset-btn');

    const handshakeStepsData = [
        { messageId: 'handshake-message-1', text: 'The client sends a "Hello" message, proposing TLS versions and cipher suites.' },
        { messageId: 'handshake-message-2', text: 'The server replies with its "Hello", choosing a cipher suite.' },
        { messageId: 'handshake-message-3', text: 'The server sends its certificate chain for client authentication.' },
        { messageId: 'handshake-message-4', text: 'Server sends key exchange parameters (optional, for ephemeral key exchange).' },
        { messageId: 'handshake-message-5', text: 'Server requests client certificate (optional, for mutual TLS).' },
        { messageId: 'handshake-message-6', text: 'Server indicates completion of its hello messages.' },
        { messageId: 'handshake-message-7', text: 'Client sends its certificate (optional, if requested).' },
        { messageId: 'handshake-message-8', text: 'Client sends key exchange data (e.g., encrypted premaster secret).' },
        { messageId: 'handshake-message-9', text: 'Client proves possession of its private key (optional).' },
        { messageId: 'handshake-message-10', text: 'Client signals transition to encrypted communication.' },
        { messageId: 'handshake-message-11', text: 'Server signals transition to encrypted communication.' },
        { messageId: 'handshake-message-12', text: 'Client sends encrypted "Finished" message, verifying handshake.' },
        { messageId: 'handshake-message-13', text: 'Server sends encrypted "Finished" message, verifying handshake.' }
    ];

    function updateHandshakeVisualization() {
        handshakeMessages.forEach((msg, index) => {
            // Show current step
            if (index === currentHandshakeStep) {
                msg.classList.add('opacity-100');
                msg.classList.remove('opacity-0');
            } else {
                msg.classList.remove('opacity-100');
                msg.classList.add('opacity-0');
            }

            // For the final step, make all arrows visible
            if (currentHandshakeStep === handshakeStepsData.length - 1) {
                msg.classList.add('opacity-100'); // Ensure all messages are visible
                msg.classList.remove('opacity-0');
            }
        });

        if (currentHandshakeStep >= 0 && currentHandshakeStep < handshakeStepsData.length) {
            handshakeExplanation.textContent = handshakeStepsData[currentHandshakeStep].text;
        } else {
            handshakeExplanation.textContent = 'Click "Next Step" to begin the handshake visualization.';
        }

        if (currentHandshakeStep === handshakeStepsData.length - 1) {
            handshakeBtn.disabled = true;
            handshakeBtn.textContent = 'Completed';
        } else {
            handshakeBtn.disabled = false;
            handshakeBtn.textContent = 'Next Step';
        }
    }

    handshakeBtn.addEventListener('click', () => {
        if (currentHandshakeStep < handshakeStepsData.length - 1) {
            currentHandshakeStep++;
            updateHandshakeVisualization();
        }
    });

    handshakeResetBtn.addEventListener('click', () => {
        currentHandshakeStep = -1;
        updateHandshakeVisualization();
    });

    // Initialize visualization
    updateHandshakeVisualization();


    // SSL Certificate Viewer & Connection Simulator (Enhanced)
    const liveTestBtn = document.getElementById('live-test-btn');
    const liveUrlInput = document.getElementById('live-url-input');
    const resultsContainer = document.getElementById('live-results-container');

    liveTestBtn.addEventListener('click', () => {
        const url = liveUrlInput.value.trim();
        resultsContainer.innerHTML = `<div class="text-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-900 mx-auto"></div><p class="mt-2">Simulating connection to ${url}...</p></div>`;

        setTimeout(() => {
            let outputHtml = '';
            if (!url) {
                outputHtml = `
                    <div class="border rounded-lg p-4 bg-red-50">
                        <h4 class="font-bold text-red-800">Error: Invalid URL</h4>
                        <p class="mt-2 text-sm">Please enter a valid URL (e.g., https://www.google.com).</p>
                    </div>`;
            } else if (url.startsWith('http://')) {
                outputHtml = `
                    <div class="border rounded-lg p-4 bg-yellow-50">
                        <h4 class="font-bold text-yellow-800">Warning: Unencrypted Connection (HTTP)</h4>
                        <p class="mt-2 text-sm">The URL you entered uses HTTP, which is not secure. Data sent over HTTP is unencrypted and vulnerable to eavesdropping and tampering. Always prefer HTTPS for secure communication.</p>
                        <p class="mt-2 text-sm"><strong>Suggested Action:</strong> Try changing the URL to HTTPS (e.g., \`https://${url.substring(7)}\`) if the server supports it.</p>
                    </div>`;
            } else if (url.includes('google.com') || url.includes('sap.com')) {
                 outputHtml = `
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <h4 class="font-bold text-green-700">✓ Secure Connection Simulated</h4>
                        <div class="mt-4 grid md:grid-cols-2 gap-4 text-sm">
                            <div><strong class="text-slate-600">Protocol:</strong> <span class="font-mono">TLS 1.3</span></div>
                            <div><strong class="text-slate-600">Cipher Suite:</strong> <span class="font-mono">TLS_AES_256_GCM_SHA384</span></div>
                            <div><strong class="text-slate-600">Key Exchange:</strong> <span class="font-mono">X25519</span></div>
                            <div><strong class="text-slate-600">Signature Algorithm:</strong> <span class="font-mono">RSA-PSS</span></div>
                        </div>
                        <div class="mt-4">
                            <strong class="text-slate-600">Certificate Chain:</strong>
                            <ol class="list-decimal list-inside mt-2 text-sm space-y-1">
                                <li><span class="font-mono">CN=*.${url.includes('google.com') ? 'google.com' : 'sap.com'}</span> (Issued by: GTS CA 1C3) <span class="text-green-600 font-semibold ml-2">✓ Valid</span></li>
                                <li><span class="font-mono">CN=GTS CA 1C3</span> (Issued by: GTS Root R1) <span class="text-green-600 font-semibold ml-2">✓ Trusted</span></li>
                                <li><span class="font-mono">CN=GTS Root R1</span> (Issued by: GlobalSign) <span class="text-green-600 font-semibold ml-2">✓ Trusted Root</span></li>
                            </ol>
                        </div>
                        <div class="mt-4">
                            <strong class="text-slate-600">Certificate Details:</strong>
                            <p class="text-sm"><strong>Issuer:</strong> CN=GTS CA 1C3, O=Google Trust Services LLC, C=US</p>
                            <p class="text-sm"><strong>Subject:</strong> CN=*.${url.includes('google.com') ? 'google.com' : 'sap.com'}, O=Google LLC, L=Mountain View, ST=California, C=US</p>
                            <p class="text-sm"><strong>Valid From:</strong> 2024-01-01 00:00:00 UTC</p>
                            <p class="text-sm"><strong>Valid To:</strong> 2025-01-01 23:59:59 UTC</p>
                            <p class="text-sm"><strong>Serial Number:</strong> 1234567890ABCDEF</p>
                            <p class="text-sm"><strong>Signature Algorithm:</strong> sha256WithRSAEncryption</p>
                            <p class="text-sm"><strong>Public Key Algorithm:</strong> id-ecPublicKey (256-bit)</p>
                        </div>
                    </div>`;
            } else if (url.includes('expired.badssl.com')) {
                outputHtml = `
                    <div class="border rounded-lg p-4 bg-red-50">
                        <h4 class="font-bold text-red-800">Error: Certificate Expired</h4>
                        <p class="mt-2 text-sm">The server presented an SSL certificate that has expired. This indicates a severe security risk and prevents a secure connection.</p>
                        <p class="mt-2 text-sm"><strong>Certificate Details:</strong></p>
                        <p class="text-sm"><strong>Issuer:</strong> CN=BadSSL Intermediate Certificate Authority, O=BadSSL</p>
                        <p class="text-sm"><strong>Subject:</strong> CN=expired.badssl.com, O=BadSSL</p>
                        <p class="text-sm"><strong>Valid From:</strong> 2015-01-01 00:00:00 UTC</p>
                        <p class="text-sm"><strong>Valid To:</strong> 2016-01-01 23:59:59 UTC <span class="text-red-600 font-semibold">(EXPIRED)</span></p>
                        <p class="text-sm"><strong>Error Code:</strong> NET::ERR_CERT_DATE_INVALID</p>
                        <p class="mt-2 text-sm"><strong>Suggested Action:</strong> The server administrator must renew the certificate.</p>
                    </div>`;
            } else if (url.includes('untrusted-root.badssl.com')) {
                outputHtml = `
                    <div class="border rounded-lg p-4 bg-red-50">
                        <h4 class="font-bold text-red-800">Error: Untrusted Certificate Authority</h4>
                        <p class="mt-2 text-sm">The server's certificate is issued by an authority that is not trusted by your system. This often happens with self-signed certificates or certificates issued by private/internal CAs not recognized publicly.</p>
                        <p class="mt-2 text-sm"><strong>Certificate Details:</strong></p>
                        <p class="text-sm"><strong>Issuer:</strong> CN=BadSSL Untrusted Root Certificate Authority, O=BadSSL</p>
                        <p class="text-sm"><strong>Subject:</strong> CN=untrusted-root.badssl.com, O=BadSSL</p>
                        <p class="text-sm"><strong>Valid From:</strong> 2020-01-01 00:00:00 UTC</p>
                        <p class="text-sm"><strong>Valid To:</strong> 2025-01-01 23:59:59 UTC</p>
                        <p class="text-sm"><strong>Error Code:</strong> NET::ERR_CERT_AUTHORITY_INVALID</p>
                        <p class="mt-2 text-sm"><strong>Suggested Action:</strong> If this is an internal server, import the Root CA certificate into your system's trust store (e.g., STRUST in SAP ABAP, NWA in SAP Java).</p>
                    </div>`;
            } else if (url.includes('wrong.host.badssl.com')) {
                 outputHtml = `
                    <div class="border rounded-lg p-4 bg-red-50">
                        <h4 class="font-bold text-red-800">Error: Hostname Mismatch</h4>
                        <p class="mt-2 text-sm">The hostname in the URL (\`wrong.host.badssl.com\`) does not match the Common Name (CN) or any Subject Alternative Names (SANs) in the server's certificate. This is a common issue for misconfigured certificates.</p>
                        <p class="mt-2 text-sm"><strong>Certificate Details:</strong></p>
                        <p class="text-sm"><strong>Issuer:</strong> CN=BadSSL Intermediate Certificate Authority, O=BadSSL</p>
                        <p class="text-sm"><strong>Subject:</strong> CN=badssl.com, O=BadSSL</p>
                        <p class="text-sm"><strong>Valid From:</strong> 2020-01-01 00:00:00 UTC</p>
                        <p class="text-sm"><strong>Valid To:</strong> 2025-01-01 23:59:59 UTC</p>
                        <p class="text-sm"><strong>Error Code:</strong> NET::ERR_CERT_COMMON_NAME_INVALID</p>
                        <p class="mt-2 text-sm"><strong>Suggested Action:</strong> Ensure the certificate's CN or SANs exactly match the hostname used in the URL. Regenerate the CSR with correct SANs if needed.</p>
                    </div>`;
            }
            else {
                 outputHtml = `
                    <div class="border rounded-lg p-4 bg-amber-50">
                        <h4 class="font-bold text-amber-800">ⓘ Simulation Notice</h4>
                        <p class="mt-2 text-sm">This is a simulated analysis for <strong>${url}</strong>. A real-world test would probe the server's configuration and display its actual TLS version, cipher suites, and full certificate chain for inspection, which is invaluable for troubleshooting connection issues.</p>
                        <p class="mt-2 text-sm">Try examples like: \`https://www.google.com\`, \`http://example.com\`, \`https://expired.badssl.com\`, \`https://untrusted-root.badssl.com\`, \`https://wrong.host.badssl.com\`.</p>
                    </div>`;
            }
            resultsContainer.innerHTML = outputHtml;
        }, 1500);
    });
    
    // sapgenpse accordion data
    const sapgenpseCommands = [
        {
            name: 'get_pse',
            summary: 'Generate a new PSE file, key pair, and self-signed certificate.',
            content: `
                <p>Used to create the initial PSE file. You define the distinguished name, algorithm, and key size. This is often the first step in setting up SSL on a new system.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash">sapgenpse get_pse -p SAPSSLS.pse -x mypin -r new_req.csr "CN=mysap.host.com, O=MyCompany, C=US" -a RSA -s 2048</code></pre>
                </div>`
        },
        {
            name: 'gen_pse',
            summary: 'Generate a Certificate Signing Request (CSR) for an existing PSE.',
            content: `
                <p>Crucial for certificate renewals. The <code>-onlyreq</code> option generates a new CSR using the existing private key in the PSE. The <code>-j</code> option ensures that any existing Subject Alternative Names (SANs) from the PSE are preserved and carried over to the new certificate request. The <code>-onlyreq</code> option instructs the tool to generate only the CSR from the existing PSE, while ignoring other parameters like the distinguished name or algorithm, as these settings are derived from the existing PSE. You can also add new SANs with <code>-k GN-dNSName:<SAN></code>.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash"># For renewal, keeping existing SANs
sapgenpse gen_pse -p SAPSSLS.pse -onlyreq -j -r renew_req.csr

# Generate CSR with new SANs
sapgenpse gen_pse -p webdisp.pse -r webdisp.csr -k GN-dNSName:webdisp.example.com -k GN-dNSName:wd.example.com "CN=webdisp.example.com"</code></pre>
                </div>`
        },
        {
            name: 'import_own_cert',
            summary: 'Import a signed certificate response from a CA into your PSE.',
            content: `
                <p>After your CA signs your CSR, you use this command to import the signed certificate back into your PSE. You must also include the CA's intermediate/root certificates using the <code>-r</code> option to complete the chain.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash">sapgenpse import_own_cert -p SAPSSLS.pse -c signed_cert.crt -r ca_bundle.crt -x mypin</code></pre>
                </div>`
        },
        {
            name: 'maintain_pk',
            summary: 'Manage the list of trusted certificates in a PSE.',
            content: `
                <p>Used to add (<code>-a</code>) or delete (<code>-d</code>) trusted CA certificates to a PSE's certificate list. This is essential for client PSEs (like SAPSSLC.pse) that need to trust external servers.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash"># Add a trusted CA certificate to the client PSE
sapgenpse maintain_pk -p SAPSSLC.pse -a some_ca.crt -x mypin

# List certificates in a PSE
sapgenpse maintain_pk -p SAPSSLS.pse -l</code></pre>
                </div>`
        },
        {
            name: 'export_p12',
            summary: 'Export the PSE (private key + certs) to a standard PKCS#12 file.',
            content: `
                <p>Creates a <code>.p12</code> or <code>.pfx</code> file. This is the standard way to move a complete certificate identity from an ABAP PSE to an SAP Java system (NWA) or a Web Dispatcher. Use <code>-z</code> for a password and <code>-C 0</code> to include the full chain.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash">sapgenpse export_p12 -p SAPSSLS.pse -x mypin -z p12pass SAPSSLS.p12 -C 0</code></pre>
                </div>`
        },
        {
            name: 'seclogin',
            summary: 'Create SSO credentials for unattended PSE access.',
            content: `
                <p>Creates a <code>cred_v2</code> file that allows the SAP system OS user (e.g., &lt;sidadm&gt;) to access the PSE without a PIN. This is mandatory for services like the ICM to start automatically and use the SSL certificate.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash">sapgenpse seclogin -p SAPSSLS.pse -x mypin -O sidadm</code></pre>
                </div>`
        },
        {
            name: 'cryptinfo',
            summary: 'Display detailed information about the SAP Cryptographic Library.',
            content: `
                <p>This command is useful for verifying the capabilities of the installed CommonCryptoLib, including supported hash algorithms, encryption algorithms, and key exchange algorithms.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash">sapgenpse cryptinfo</code></pre>
                </div>`
        },
        {
            name: 'get_my_name',
            summary: 'Retrieve and display the Distinguished Name (DN) of the certificate in a PSE.',
            content: `
                <p>Displays the subject DN of the certificate stored in the specified PSE. Use <code>-v</code> for verbose output.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash">sapgenpse get_my_name -p SAPSSLS.pse -x mypin -v</code></pre>
                </div>`
        },
        {
            name: '-chpin',
            summary: 'Change the PIN of an existing PSE.',
            content: `
                <p>Allows you to change the password protecting your PSE file.</p>
                <div class="code-block mt-2">
                    <button class="copy-btn">Copy</button>
                    <pre><code class="language-bash">sapgenpse -chpin -x oldpin -X newpin -p SAPSSLS.pse</code></pre>
                </div>`
        }
    ];

    const accordionContainer = document.getElementById('sapgenpse-accordion');
    sapgenpseCommands.forEach(cmd => {
        const item = document.createElement('div');
        item.className = 'border border-stone-200 rounded-lg bg-white';
        item.innerHTML = `
            <button class="sapgenpse-accordion-header w-full text-left p-4 flex justify-between items-center font-semibold text-slate-800 hover:bg-slate-50">
                <span><code class="text-base text-teal-700 font-bold">${cmd.name}</code>: ${cmd.summary}</span>
                <span class="transform transition-transform duration-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </span>
            </button>
            <div class="sapgenpse-accordion-content px-4 pb-4">
                ${cmd.content}
            </div>
        `;
        accordionContainer.appendChild(item);
    });
    
    // sapgenpse accordion logic
    document.querySelectorAll('.sapgenpse-accordion-header').forEach(button => {
        button.addEventListener('click', () => {
            const content = button.nextElementSibling;
            const icon = button.querySelector('span.transform');
            
            if (content.style.display === "block") {
                content.style.maxHeight = null;
                content.style.display = "none";
                icon.classList.remove('rotate-180');
            } else {
                content.style.display = "block";
                content.style.maxHeight = content.scrollHeight + "px";
                icon.classList.add('rotate-180');
            }
        });
    });

    // Copy button logic
    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('copy-btn')) {
            const button = e.target;
            const pre = button.nextElementSibling;
            const code = pre.querySelector('code');
            const text = code.innerText;

            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            button.textContent = 'Copied!';
            setTimeout(() => {
                button.textContent = 'Copy';
            }, 2000);
        }
    });

    // Comprehensive sapgenpse -h output for LLM context
    const sapgenpseHelpText = `
Usage: sapgenpse <command> [options]

Commands:
  get_pse             Generate a new PSE file, key pair, and self-signed certificate.
                      Syntax: get_pse [-x PIN] [-a <algorithm>] [-s <key_len>] [-noreq | -onlyreq] <PSE_name> <Distinguished_Name>
                      Example: sapgenpse get_pse -p SAPSSLS.pse -x mypin "CN=mysap.host.com, O=MyCompany, C=US" -a RSA -s 2048

  gen_pse             Generate a Certificate Signing Request (CSR) for an existing PSE.
                      Syntax: gen_pse [-x PIN] [-p <PSE_name>] [-r <csr_file>] [-onlyreq] [-j] [-k <SAN_type>:<SAN_value>] <Distinguished_Name>
                      Example (new PSE & CSR): sapgenpse gen_pse -p new.pse -r new.csr "CN=test.com"
                      Example (CSR for existing PSE): sapgenpse gen_pse -p existing.pse -onlyreq -j -r renew.csr
                      Example (CSR with SANs): sapgenpse gen_pse -p webdisp.pse -r webdisp.csr -k GN-dNSName:webdisp.example.com -k GN-dNSName:wd.example.com "CN=webdisp.example.com"

  import_own_cert     Import a signed certificate response from a CA into your PSE.
                      Syntax: import_own_cert [-x PIN] -p <PSE_file> -c <Cert_file> [-r <RootCA_cert_file>]
                      Example: sapgenpse import_own_cert -p SAPSSLS.pse -c signed_cert.crt -r ca_bundle.crt -x mypin

  maintain_pk         Manage the list of trusted certificates in a PSE.
                      Syntax (add): maintain_pk [-x PIN] -p <PSE_name> -a <cert_file>
                      Syntax (delete): maintain_pk [-x PIN] -p <PSE_name> -d <number>
                      Syntax (list): maintain_pk [-x PIN] -p <PSE_name> -l [number]
                      Example (add): sapgenpse maintain_pk -p SAPSSLC.pse -a some_ca.crt -x mypin
                      Example (list): sapgenpse maintain_pk -p SAPSSLS.pse -l

  export_own_cert     Export the public-key certificate from a PSE.
                      Syntax: export_own_cert [-x PIN] -o <output_file> -p <PSE_name>
                      Example: sapgenpse export_own_cert -o server.crt -p SAPSSLS.pse -x mypin

  export_p12          Export the PSE (private key + certs) to a standard PKCS#12 file.
                      Syntax: export_p12 [-x PIN] -p <PSE_name> [-z <password>] [-C <count>] <filename>.p12
                      Example: sapgenpse export_p12 -p SAPSSLS.pse -x mypin -z p12pass SAPSSLS.p12 -C 0

  seclogin            Create SSO credentials for unattended PSE access.
                      Syntax: seclogin [-x PIN] -p <PSE_name> -O <user_ID>
                      Example: sapgenpse seclogin -p SAPSSLS.pse -x mypin -O sidadm

  cryptinfo           Display detailed information about the SAP Cryptographic Library.
                      Syntax: cryptinfo
                      Example: sapgenpse cryptinfo

  get_my_name         Retrieve and display the Distinguished Name (DN) of the certificate in a PSE.
                      Syntax: get_my_name [-p <PSE_name>] [-x <PIN>]
                      Example: sapgenpse get_my_name -p SAPSSLS.pse -x mypin

  -chpin              Change the PIN of an existing PSE.
                      Syntax: -chpin [-x <old_PIN>] [-X <new_PIN>] -p <PSE_name>
                      Example: sapgenpse -chpin -x oldpin -X newpin -p SAPSSLS.pse

Global Options:
  -v                  Verbose output.
  -h                  Display this help message.
  -i                  Interactive mode.
  -trace <level>      Set trace level.

Algorithms:
  RSA, DSA, ECC

Key Lengths:
  1024, 2048, 4096 (depends on algorithm)

Subject Alternative Name (SAN) Types:
  GN-dNSName (DNS Name)
  GN-iPAddress (IP Address)
  GN-rfc822Name (Email Address)
  GN-uniformResourceIdentifier (URI)
`;

    // Declare apiKey and geminiApiUrl once in the outer scope of the DOMContentLoaded listener
    // IMPORTANT: API key embedded as requested.
    const apiKey = process.env.YOUR_API_KEY; // This line attempts to read the environment variable
    const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;


    // LLM Integration: sapgenpse Command Generator
    const generateSapgenpseBtn = document.getElementById('generate-sapgenpse-btn');
    const sapgenpsePromptInput = document.getElementById('sapgenpse-prompt');
    const sapgenpseOutputDiv = document.getElementById('sapgenpse-output');
    const sapgenpseOutputCode = sapgenpseOutputDiv.querySelector('code');
    const sapgenpseLoading = document.getElementById('sapgenpse-loading');

    generateSapgenpseBtn.addEventListener('click', async () => {
        const promptText = sapgenpsePromptInput.value.trim();
        if (!promptText) {
            sapgenpseOutputDiv.classList.add('hidden');
            alert('Please describe the sapgenpse command you want to generate.');
            return;
        }

        sapgenpseOutputDiv.classList.add('hidden');
        sapgenpseLoading.classList.remove('hidden');

        try {
            let chatHistory = [];
            // Updated prompt for accuracy and fallback to help text
            chatHistory.push({ role: "user", parts: [{ text: `As an expert SAP Basis consultant, generate the exact 'sapgenpse' command based on the following description. Ensure accuracy in syntax, options, and parameters. If you are unsure about the exact command or options, instead provide the relevant section from the provided 'sapgenpse -h' help text that would guide the user. Do NOT add any extra conversational text, just the command or the help text.

Description: ${promptText}

---
sapgenpse -h help text (for reference, use relevant sections if unsure):
${sapgenpseHelpText}
---
` }] });
            const payload = { contents: chatHistory };
            const response = await fetch(geminiApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            console.log('Sapgenpse Command Generator - API Response Object:', response); // Log the full response object
            const result = await response.json();
            console.log('Sapgenpse Command Generator - API Result JSON:', result); // Log the parsed JSON result

            if (response.ok && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const generatedContent = result.candidates[0].content.parts[0].text.trim();
                
                // Heuristic to check if it's a command or help text
                if (generatedContent.startsWith('sapgenpse') || generatedContent.includes('Usage: sapgenpse')) {
                    sapgenpseOutputCode.textContent = generatedContent;
                    sapgenpseOutputDiv.classList.remove('hidden');
                } else {
                    // Assume it's a relevant help section if it doesn't start with 'sapgenpse'
                    sapgenpseOutputCode.textContent = `Could not generate a precise command. Here is a relevant section from 'sapgenpse -h' that might help:\n\n${generatedContent}`;
                    sapgenpseOutputDiv.classList.remove('hidden');
                }
            } else if (!response.ok) {
                sapgenpseOutputCode.textContent = `Error: API request failed with status ${response.status} (${response.statusText}). Please check network or API service. If you're deploying this outside of Google Canvas, ensure you've replaced "YOUR_GEMINI_API_KEY" in the code with a valid key.`;
                sapgenpseOutputDiv.classList.remove('hidden');
            } else {
                sapgenpseOutputCode.textContent = 'Error: Could not generate command. Unexpected API response structure. Check console for details.';
                sapgenpseOutputDiv.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error calling Gemini API for sapgenpse command:', error);
            sapgenpseOutputCode.textContent = `Error: Failed to connect or process API response. Details: ${error.message}. Please check your network or try again later.`;
            sapgenpseOutputDiv.classList.remove('hidden');
        } finally {
            sapgenpseLoading.classList.add('hidden');
        }
    });

    // Define the JSON schema for troubleshooting output
    const troubleshootingSchema = {
        type: "OBJECT",
        properties: {
            title: { type: "STRING" },
            sections: {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        heading: { type: "STRING" },
                        type: { type: "STRING", enum: ["ordered-list", "unordered-list"] },
                        items: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    title: { type: "STRING" },
                                    description: { type: "STRING" }, // Can contain markdown, including code blocks
                                    sub_items: {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                title: { type: "STRING" },
                                                content: { type: "STRING" } // Can contain markdown, including code blocks
                                            }
                                        }
                                    }
                                },
                                required: ["title", "description"]
                            }
                        }
                    },
                    required: ["heading", "type", "items"]
                }
            }
        },
        required: ["title", "sections"]
    };

    // Basic Markdown to HTML converter
    function markdownToHtml(markdown) {
        // Ensure markdown is a string before processing
        if (typeof markdown !== 'string' || markdown === null) {
            return '';
        }

        let html = markdown;

        // Handle multiline code blocks first to prevent inner backticks from being processed
        html = html.replace(/```bash\n([\s\S]*?)```/g, (match, code) => {
            return `<div class="code-block mt-2"><button class="copy-btn">Copy</button><pre><code class="language-bash">${code.trim()}</code></pre></div>`;
        });

        // Convert inline code blocks (backticks)
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

        // Convert bold text
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Convert newlines to <br> for simple line breaks within text
        html = html.replace(/\n/g, '<br>');

        return html;
    }

    // LLM Integration: SSL Troubleshooting Assistant
    const troubleshootBtn = document.getElementById('troubleshoot-btn');
    const troubleshootingPromptInput = document.getElementById('troubleshooting-prompt');
    const troubleshootingOutputDiv = document.getElementById('troubleshooting-output');
    const troubleshootingLoading = document.getElementById('troubleshooting-loading');

    troubleshootBtn.addEventListener('click', async () => {
        const promptText = troubleshootingPromptInput.value.trim();
        if (!promptText) {
            troubleshootingOutputDiv.classList.add('hidden');
            alert('Please describe the SSL/TLS error or scenario.');
            return;
        }

        troubleshootingOutputDiv.classList.add('hidden');
        troubleshootingLoading.classList.remove('hidden');

        try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: `As an expert SAP Basis consultant, provide possible causes and solutions for the following SSL/TLS error or scenario. Focus on practical steps relevant to SAP environments (ABAP, Java, Web Dispatcher). Provide the response in JSON format according to the following schema. The 'description' and 'content' fields can contain Markdown (e.g., **bold**, \`inline code\`, \`\`\`bash\\ncode\\n\`\`\`).

Schema:
${JSON.stringify(troubleshootingSchema, null, 2)}

Error/Scenario: ${promptText}` }] });
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: troubleshootingSchema
                }
            };
            const response = await fetch(geminiApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            console.log('Troubleshooting Assistant - API Response Object:', response); // Log the full response object
            const result = await response.json();
            console.log('Troubleshooting Assistant - API Result JSON:', result); // Log the parsed JSON result

            if (response.ok && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const jsonResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('Parsed JSON Response:', jsonResponse);

                let formattedOutput = `<h4 class="font-bold text-slate-800">${jsonResponse.title ?? 'Troubleshooting Results'}</h4>`; // Use nullish coalescing for title

                jsonResponse.sections.forEach(section => {
                    formattedOutput += `<h4 class="font-bold text-slate-800 mt-4">${section.heading ?? 'Unnamed Section'}:</h4>`; // Use nullish coalescing for heading
                    const listTag = section.type === 'ordered-list' ? 'ol' : 'ul';
                    const listClass = section.type === 'ordered-list' ? 'list-decimal' : 'list-disc';
                    formattedOutput += `<${listTag} class="${listClass} pl-5 mt-2 space-y-2">`;

                    section.items.forEach(item => {
                        formattedOutput += `<li><strong>${item.title ?? 'Untitled Item'}:</strong> ${markdownToHtml(item.description ?? '')}`; // Use nullish coalescing for title and description
                        if (item.sub_items && item.sub_items.length > 0) {
                            formattedOutput += `<ul class="list-disc ml-4 mt-1 space-y-1">`;
                            item.sub_items.forEach(subItem => {
                                formattedOutput += `<li><strong>${subItem.title ?? 'Untitled Sub-item'}:</strong> ${markdownToHtml(subItem.content ?? '')}</li>`; // Use nullish coalescing for title and content
                            });
                            formattedOutput += `</ul>`;
                        }
                        formattedOutput += `</li>`;
                    });
                    formattedOutput += `</${listTag}>`;
                });

                troubleshootingOutputDiv.innerHTML = formattedOutput;
                troubleshootingOutputDiv.classList.remove('hidden');
            } else if (!response.ok) {
                troubleshootingOutputDiv.innerHTML = `<p class="text-sm text-red-600">Error: API request failed with status ${response.status} (${response.statusText}). Please check network or API service. If you're deploying this outside of Google Canvas, ensure you've replaced "YOUR_GEMINI_API_KEY" in the code with a valid key.`;
                troubleshootingOutputDiv.classList.remove('hidden');
            } else {
                troubleshootingOutputDiv.innerHTML = '<p class="text-sm text-red-600">Error: Could not retrieve solutions. Unexpected API response structure. Check console for details.</p>';
                troubleshootingOutputDiv.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error calling Gemini API for troubleshooting:', error);
            troubleshootingOutputDiv.innerHTML = `<p class="text-sm text-red-600">Error: Failed to connect or process API response. Details: ${error.message}. Please check your network or try again later.</p>`;
            troubleshootingOutputDiv.classList.remove('hidden');
        } finally {
            troubleshootingLoading.classList.add('hidden');
        }
    });

});
</script>

</body>
</html>
